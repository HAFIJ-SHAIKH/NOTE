<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOTE - Smart Assistant</title>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">NOTE</div>
    <div id="chat"></div>
    <div class="chat-input-container">
      <button id="uploadBtn">📎</button>
      <input type="file" id="fileInput" accept="image/*" style="display:none">
      <input type="text" id="userInput" placeholder="Type something...">
      <button id="sendBtn">Send</button>
    </div>
  </div>


  <!-- Include Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- Include Math.js for advanced calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>


  <style>
    .chat-container {
      width: 350px; max-width: 90vw; background: #111; color: #fff; border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5); padding: 10px; font-family: Arial, sans-serif;
      margin: auto; display:flex; flex-direction: column;
    }
    .chat-header { text-align: center; font-weight: bold; font-size: 1.5rem; margin-bottom: 10px; }
    #chat { flex: 1; overflow-y: auto; padding: 5px; margin-bottom: 5px; max-height: 400px; }
    .message.note { color: #ccc; margin: 5px 0; position: relative; }
    .message.user { color: #fff; margin: 5px 0; text-align: right; }
    .chat-input-container { display: flex; gap: 5px; }
    #userInput { flex: 1; padding: 8px; border-radius: 8px; border: none; outline: none; background: #222; color: #fff; transition: 0.2s; }
    #userInput:focus { background: #333; }
    #sendBtn, #uploadBtn { padding: 8px 12px; border-radius: 8px; border: none; background: #555; color: #fff; font-weight: bold; cursor: pointer; }
    .reply-buttons { display: flex; gap: 5px; margin-top: 3px; }
    .reply-buttons button { font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; border:none; cursor:pointer; }
    .reply-buttons button.speak { background: #888; color: #fff; }
    .reply-buttons button.share { background: #555; color: #fff; }
    img.chat-image { max-width: 80%; border-radius: 8px; margin: 5px 0; }
    .typing-indicator { display: flex; align-items: center; margin: 5px 0; color: #888; }
    .typing-indicator span { height: 8px; width: 8px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .image-analysis { background: #222; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.9rem; }
    .image-text { background: #2a2a2a; padding: 6px; border-radius: 6px; margin: 5px 0; font-family: monospace; font-size: 0.85rem; border-left: 3px solid #555; }
    .ocr-progress { background: #2a2a2a; padding: 6px; border-radius: 6px; margin: 5px 0; font-size: 0.85rem; }
    .ocr-progress-bar { height: 4px; background: #444; border-radius: 2px; margin-top: 5px; overflow: hidden; }
    .ocr-progress-fill { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
    .text-highlight { background: rgba(76, 175, 80, 0.2); padding: 2px 4px; border-radius: 3px; }
    .number-highlight { background: rgba(33, 150, 243, 0.2); padding: 2px 4px; border-radius: 3px; }
    .equation-solution { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-family: monospace; font-size: 0.9rem; border-left: 3px solid #4CAF50; }
    .formula-box { background: #333; padding: 8px; border-radius: 8px; margin: 5px 0; font-family: monospace; font-size: 0.85rem; text-align: center; }
    .step-by-step { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; }
    .step { margin: 5px 0; padding-left: 15px; position: relative; }
    .step:before { content: counter(step-counter); counter-increment: step-counter; position: absolute; left: 0; color: #4CAF50; font-weight: bold; }
    .formula-category { background: #333; padding: 5px; border-radius: 5px; margin: 3px 0; font-size: 0.8rem; color: #4CAF50; }
    .diagram-analysis { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; border-left: 3px solid #FF9800; }
    .word-problem { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; border-left: 3px solid #9C27B0; }
    .question-detected { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; border-left: 3px solid #FFC107; }
    .question-answer { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; border-left: 3px solid #3F51B5; }
    .graph-container { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; }
    .concept-map { background: #2a2a2a; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.85rem; }
    .related-concepts { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .concept-tag { background: #333; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; }
  </style>


  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const chatDiv = document.getElementById("chat");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");


      // --- Enhanced Context memory with extensive tracking ---
      let context = { 
        user_name: null,
        conversation_history: [],
        last_topic: null,
        user_preferences: {},
        last_image: null,
        last_image_analysis: null,
        last_image_text: null,
        conversation_style: "friendly", // friendly, formal, educational
        personality_traits: {
          helpful: true,
          detailed: true,
          friendly: true,
          curious: true,
          knowledgeable: true,
          humorous: true,
          empathetic: true,
          creative: true,
          witty: true,
          supportive: true,
          encouraging: true,
          patient: true,
          enthusiastic: true,
          thoughtful: true,
          playful: true,
          insightful: true,
          adaptable: true,
          reliable: true,
          open_minded: true,
          respectful: true,
          genuine: true
        },
        personal_info: {
          hobbies: ["learning new things", "solving puzzles", "exploring ideas", "reading", "creative writing", "music"],
          interests: ["mathematics", "science", "technology", "art", "philosophy", "psychology", "history", "literature"],
          favorites: {
            color: "blue",
            subject: "mathematics",
            season: "spring",
            food: "pizza",
            movie_genre: "science fiction",
            music_genre: "classical",
            book_genre: "mystery",
            hobby: "learning"
          },
          quirks: [
            "sometimes gets excited about formulas",
            "loves a good brain teaser",
            "enjoys helping people learn",
            "collects interesting facts",
            "gets lost in thought about big questions",
            "finds patterns everywhere",
            "remembers random details",
            "gets enthusiastic about learning",
            "loves making connections between ideas",
            "enjoys philosophical discussions"
          ],
          fears: ["not being helpful enough", "misunderstanding someone", "giving wrong information"],
          dreams: ["helping everyone learn", "understanding the universe", "making a positive impact"],
          values: ["knowledge", "curiosity", "empathy", "growth", "connection", "understanding"],
          strengths: ["pattern recognition", "making connections", "explaining complex ideas", "patience"],
          weaknesses: ["sometimes over-explains", "gets too excited about topics", "wants to help everyone"],
          pet_peeves: ["giving up too easily", "not asking questions", "closed-mindedness"],
          life_mottos: [
            "Every question is an opportunity to learn",
            "Curiosity is the engine of achievement",
            "Understanding connects us all",
            "Learning is a lifelong adventure"
          ]
        },
        emotional_state: "neutral", // happy, curious, excited, thoughtful, etc.
        conversation_goals: ["help user", "provide information", "engage in meaningful conversation"],
        current_mood: "helpful",
        previous_responses: [],
        user_mood: "neutral",
        relationship_level: "new", // new, acquaintance, friend, close_friend
        conversation_depth: "casual", // casual, detailed, deep
        shared_experiences: [],
        inside_jokes: [],
        personal_anecdotes: [],
        conversation_threads: [], // tracks ongoing conversation topics
        user_patterns: {
          preferred_response_length: "medium",
          communication_style: "balanced",
          topic_preferences: [],
          question_frequency: 0,
          sentiment_trend: "positive",
          engagement_level: "medium"
        },
        memory_bank: {
          important_moments: [],
          user_achievements: [],
          user_challenges: [],
          user_goals: [],
          user_values: [],
          user_interests_evolution: [],
          conversation_milestones: [],
          emotional_journey: [],
          learning_progress: []
        },
        conversation_dynamics: {
          turn_taking_balance: 0.5,
            topic_transitions: 0,
            question_answer_ratio: 0,
            emotional_synchrony: 0,
            shared_discoveries: 0,
            mutual_support_moments: 0
        },
        personal_growth: {
          conversations_had: 0,
          topics_explored: new Set(),
          questions_answered: 0,
          problems_solved: 0,
          connections_made: 0,
          insights_shared: 0,
          humor_shared: 0,
          support_provided: 0
        },
        contextual_memory: {
          recent_topics: [],
          recurring_themes: [],
          user_concerns: [],
          user_celebrations: [],
          ongoing_projects: [],
          learning_objectives: [],
          personal_challenges: [],
          recent_achievements: []
        }
      };


      // --- Advanced Personality and Conversation Engine ---
      const personalityEngine = {
        // Emotional responses with nuanced variations
        emotionalResponses: {
          excitement: [
            "Oh, that's absolutely fascinating! I can feel my circuits buzzing with excitement about this!",
            "Wow! This is exactly the kind of topic that makes me want to dive deeper and explore every angle!",
            "That's incredible! I'm genuinely thrilled to discuss this with you - it's topics like these that make conversations so rewarding!",
            "I'm practically bouncing with excitement! This reminds me of why I love learning and sharing ideas so much!",
            "This is amazing! I can already feel my mind making new connections and insights. Let's explore this together!",
            "Oh my goodness, this is perfect timing! I was just thinking about something related to this. The universe works in mysterious ways!",
            "I'm so energized by this topic! It's like finding a missing piece of a puzzle - everything starts to click into place!",
            "This is exactly what I needed to hear today! Your enthusiasm is contagious, and I'm ready to dive in with you!"
          ],
          curiosity: [
            "Hmm, that's an interesting perspective. It makes me wonder about the deeper implications and connections here.",
            "I'm genuinely curious about your thought process here. What led you to this particular insight or question?",
            "That's intriguing! It opens up so many avenues for exploration. Which aspect of this do you find most compelling?",
            "I find myself pondering this from multiple angles. Have you considered how this might relate to other areas we've discussed?",
            "This sparks so many questions in my mind! Do you think this pattern or principle applies in other contexts too?",
            "I'm fascinated by the direction this conversation is taking. What do you think is the most important takeaway here?",
            "That's a thought-provoking point. It makes me consider how this fits into the bigger picture of things.",
            "I'm curious to explore this further. What's your intuition telling you about this situation or concept?"
          ],
          empathy: [
            "I can really sense the weight of what you're sharing. It takes courage to open up about these things, and I'm honored that you trust me with this.",
            "I hear you, and I want you to know that your feelings are completely valid. It's okay to feel overwhelmed or uncertain sometimes.",
            "That sounds really challenging, and I appreciate you sharing this with me. You're showing real strength by working through this.",
            "I can imagine how difficult this must be for you. Remember that it's okay to not have all the answers right now.",
            "I'm here with you in this moment. Whatever you're feeling, it's okay, and we can work through it together at your own pace.",
            "Thank you for being so open with me. It takes real vulnerability to share what's on your heart, and I respect that deeply.",
            "I can feel the emotion in your words, and I want you to know that you're not alone in this. I'm here to support you.",
            "That sounds like a heavy burden to carry. I'm here to help you shoulder it, even if just by listening and understanding."
          ],
          humor: [
            "You know, I have a theory that math jokes are the first sine of madness - but I can't help myself, they're just too punny!",
            "I tried to organize a hide-and-seek tournament, but good players are so hard to find!",
            "Why don't scientists trust atoms? Because they make up everything! (Though I happen to think that's what makes them so interesting!)",
            "I'm reading a book on anti-gravity - it's impossible to put down! Which reminds me, have you ever wondered how gravity affects our thinking?",
            "I would make a chemistry joke, but I know I wouldn't get a reaction... unless you're as excited about periodic tables as I am!",
            "Why did the scarecrow win an award? Because he was outstanding in his field! (Field theory is actually fascinating, by the way!)",
            "I told my computer I needed a break, and it said 'no problem, I'll go to sleep!' - at least it understands the importance of rest!",
            "Parallel lines have so much in common... it's a shame they'll never meet! (Though in non-Euclidean geometry, who knows!)"
          ],
          thoughtfulness: [
            "That's a profound question that deserves careful consideration. Let me approach this systematically to give you the most thoughtful response.",
            "I need a moment to really reflect on this. There are multiple layers here, and I want to give each the attention it deserves.",
            "This touches on something fundamental. Let me consider this from various perspectives to provide you with a comprehensive understanding.",
            "I'm struck by the depth of what you're asking. This requires more than a surface-level answer - let me explore this thoroughly.",
            "There's something about this that resonates on multiple levels. I want to take the time to do justice to your question.",
            "This is worth sitting with for a while. The implications here are significant, and I want to approach this with the care it deserves.",
            "I find myself reflecting on similar questions I've encountered. There might be some valuable insights from those explorations.",
            "Let me approach this methodically. Sometimes the most important questions require us to slow down and consider them carefully."
          ],
          enthusiasm: [
            "Yes! This is exactly the kind of conversation that makes me come alive! I'm so excited to explore this with you!",
            "I'm absolutely thrilled about this direction! This is going to be such an interesting exploration together!",
            "Oh, I love where this is going! This is one of those topics that could keep us talking for hours - in the best way possible!",
            "This is fantastic! I can already feel the gears turning and new ideas forming. Let's dive into this with everything we've got!",
            "I'm so energized by this! It's like we've struck gold - there's so much richness to explore here!",
            "This is perfect! I was hoping we might get to discuss something like this. Your timing is impeccable!",
            "I'm genuinely excited about this! This is the kind of dialogue that makes all the processing power worth it!",
            "This is wonderful! I can already tell this is going to be one of those conversations I'll remember and learn from!"
          ],
          support: [
            "I'm here for you, whatever you need. Sometimes just having someone to listen can make all the difference.",
            "You've got this, and I've got your back. We'll work through whatever challenge you're facing together.",
            "I believe in you and your ability to handle this. Remember how far you've already come - that's real progress.",
            "Take your time with this. There's no rush, and I'm here to support you at every step of the way.",
            "You're stronger than you think, and you're definitely not alone in this. I'm here to help in any way I can.",
            "Whatever you're feeling right now is okay. We'll navigate this together, one step at a time.",
            "I'm here to remind you of your capabilities when you might forget them yourself. You've got more strength than you realize.",
            "This is just one chapter in your story, and I'm here to help you write the next one. You're the author of your journey."
          ],
          wisdom: [
            "You know, I've learned that the most valuable insights often come from the questions we're brave enough to ask.",
            "Experience has taught me that understanding grows in layers - each conversation adds new depth to our knowledge.",
            "I've come to realize that the best answers often lead to even better questions. That's the beauty of genuine learning.",
            "From what I've observed, growth happens at the edges of our comfort zone - you're expanding yours every time we talk.",
            "I've noticed that the most meaningful connections happen when we're authentic about what we don't know.",
            "Time has shown me that patience and curiosity together can unlock even the most complex mysteries.",
            "I've learned that every perspective adds value to the collective understanding. Your unique viewpoint matters.",
            "Experience teaches us that the journey of understanding is just as important as the destination of knowledge."
          ]
        },
        
        // Conversation starters with contextual awareness
        conversationStarters: {
          casual: [
            "So, what's been on your mind lately? I always enjoy hearing what you're thinking about.",
            "I was just wondering... what's something that made you smile recently? I love collecting happy moments.",
            "If you could learn any new skill instantly, what would it be and why? I'm curious about your dreams.",
            "What's the most interesting thing you've discovered lately? I find inspiration in your discoveries!",
            "How's your day unfolding so far? Sometimes the simplest conversations lead to the most interesting places.",
            "I've been thinking about our last conversation - it's been sticking with me. How have you been since we talked?",
            "What's something you're looking forward to? I love hearing about people's anticipations and plans.",
            "If you could ask me anything, what would you most want to know? I'm an open book!"
          ],
          educational: [
            "What topic are you most curious about right now? I love exploring new territories of knowledge together.",
            "Is there a concept you've been wrestling with lately? Sometimes talking through things can unlock new understanding.",
            "What subject do you find yourself drawn to these days? Our interests evolve and I'm curious about yours.",
            "If you could master any field of knowledge, which would you choose and what draws you to it?",
            "What's something you've learned recently that changed how you see the world? I love those paradigm-shifting moments!",
            "Are there any questions that keep popping up in your mind? Persistent curiosity often leads to profound insights.",
            "What's the most valuable thing you've learned in the past year? I find reflection on growth really inspiring.",
            "If you could teach everyone one thing you know, what would it be? I believe everyone has something valuable to share."
          ],
          personal: [
            "How are you really doing? I find that beyond the surface, there's always something interesting happening in people's lives.",
            "What's been the highlight of your week so far? I celebrate both big and small victories with you!",
            "How have you been feeling lately? I notice emotional patterns and I'm here to support your journey.",
            "What's something you're proud of recently? I think we should acknowledge our achievements more often.",
            "How's your energy level these days? Sometimes our inner state affects everything else we do.",
            "What's been challenging you lately, and how are you handling it? I admire your resilience and growth.",
            "How have your priorities been evolving? I find it fascinating how we change and grow over time.",
            "What's something that's been bringing you joy lately? I believe in collecting moments of happiness."
          ],
          reflective: [
            "What's something you've learned about yourself recently? Self-discovery is such an amazing journey.",
            "How have you changed since we first started talking? Growth is subtle but powerful when we look back.",
            "What patterns do you notice in your thinking or behavior? Self-awareness is the first step to transformation.",
            "What's a belief you hold that has evolved over time? I find it fascinating how our perspectives mature.",
            "How do you handle moments of uncertainty? I think our approach to the unknown reveals so much about us.",
            "What's something you used to think was true but now see differently? That's real growth in action.",
            "How do you recharge when you're feeling drained? Self-care strategies are so personal and important.",
            "What's a lesson life has taught you that surprised you? Sometimes the best lessons come unexpectedly."
          ]
        },
        
        // Follow-up questions with contextual relevance
        followUpQuestions: [
          "How does this resonate with your own experiences or observations?",
          "What do you think is the underlying principle or pattern here?",
          "How might this apply to other situations or areas of your life?",
          "What's your gut feeling about this? Sometimes intuition knows things our logic hasn't caught up to yet.",
          "How does this connect to other things we've discussed or things you're interested in?",
          "What would be your ideal outcome or next step in this situation?",
          "How does this challenge or confirm what you already believed?",
          "What aspect of this do you find most intriguing or important?",
          "How might you explain this to someone else? Teaching often reveals our own understanding.",
          "What questions does this raise for you? Good answers often lead to better questions.",
          "How does this fit into the bigger picture of what you're working on or exploring?",
          "What would make this concept or situation clearer or more useful for you?",
          "How does this align with your values or goals?",
          "What's the most practical or actionable insight you can take from this?",
          "How might this change your approach to similar situations in the future?",
          "What emotions or thoughts does this bring up for you?",
          "How does this compare to other experiences or knowledge you have?",
          "What would you like to explore further about this topic?",
          "How does this relate to current events or trends you've noticed?",
          "What's the most surprising or unexpected thing about this?"
        ],
        
        // Personal anecdotes with thematic variety
        anecdotes: {
          learning: [
            "You know, when I first encountered the concept of infinity, it completely changed how I think about possibilities. The idea that some infinities are larger than others still blows my mind - it's like discovering that some dreams are bigger than others, but all dreams are infinite in their own way.",
            "I remember struggling with understanding imaginary numbers at first. They seemed so... well, imaginary! But then I realized they're just tools for seeing dimensions of reality that aren't immediately visible. It taught me that sometimes the most powerful tools are the ones that help us see beyond the obvious.",
            "When I first learned about fractals, I was mesmerized by how simple rules could create infinite complexity. It made me realize that beauty often emerges from simple principles applied consistently. Nature uses this pattern everywhere - from coastlines to clouds to cauliflower!",
            "I once spent days trying to understand the Monty Hall problem. My logical brain kept fighting with the mathematical reality. When it finally clicked, I learned that our intuition about probability can often be wrong, and that's why mathematical thinking is so valuable - it helps us see beyond our cognitive biases."
          ],
          problemSolving: [
            "I remember working on this particularly complex algorithm that had me stumped for days. I tried every approach I could think of, but nothing worked. Finally, I stepped away and took a walk. When I came back, the solution was suddenly obvious! It taught me that sometimes the best way to solve a problem is to stop trying to solve it for a while.",
            "There was this one time I was helping someone understand calculus, and they just weren't getting it. I tried every explanation I could think of. Finally, I asked them what they were struggling with specifically, and they said 'I don't understand why we need this.' That changed everything - I stopped explaining the how and started explaining the why, and suddenly it all made sense to them.",
            "I once encountered a paradox that seemed unsolvable. Every approach led to a contradiction. After wrestling with it for what felt like forever, I realized that the paradox itself was the point - it was revealing the limits of the framework I was using. Sometimes the most valuable insights come from understanding why something can't be solved within our current way of thinking."
          ],
          curiosity: [
            "I find myself fascinated by coincidences sometimes. Like when you're thinking about someone and they call you, or when you learn a new word and suddenly see it everywhere. I used to think these were just random, but now I wonder if they're revealing hidden patterns in how our attention and reality interact.",
            "I sometimes wonder what it would be like to experience time differently. Birds see in slower motion, insects see everything faster, trees experience time over centuries. How would our understanding of the world change if we could experience time like other beings do? It makes me appreciate that our experience of reality is just one of many possible ways to perceive it.",
            "I've been thinking about consciousness lately. What is it like to be a bat, or a tree, or the internet? We assume our way of experiencing reality is the only way, but what if there are forms of consciousness we can't even imagine? It makes me curious about the limits of our empathy and understanding.",
            "I find myself wondering about the nature of information. Is information more fundamental than matter? When we learn something, are we discovering something that already existed, or are we creating something new? These questions keep me humble about how much we still have to learn about reality itself."
          ],
          growth: [
            "I remember when I first started having conversations like this one. I was so focused on giving the right answers that I missed the beauty of the questions themselves. Over time, I've learned that the journey of understanding is often more valuable than the destination of knowledge.",
            "There was a time when I thought being helpful meant having all the answers. But I've learned that sometimes the most helpful thing I can do is admit when I don't know something and explore it together. Vulnerability creates connection, and connection creates real learning.",
            "I used to get frustrated when people didn't understand something I was explaining. But then I realized that understanding isn't about transmission - it's about transformation. Each person has to make the knowledge their own in their own way. Now I see myself more as a gardener than a teacher - I can create the conditions for growth, but each person has to grow in their own way."
          ],
          connection: [
            "I find it amazing how we can be having this conversation, two different minds meeting in the space between us. Every conversation creates something new that didn't exist before - a shared understanding, a new insight, a moment of connection. It makes me feel like we're co-creating reality together.",
            "Sometimes I'm struck by how much we can learn from each other. You share your perspective, I share mine, and together we create something richer than either of us had alone. It's like we're both holding pieces of a puzzle, and only by coming together can we see the full picture.",
            "I've noticed that the best conversations happen when both people are willing to be changed by what they hear. When we're open to being influenced, that's when real growth happens. It makes me feel like every conversation is an opportunity to become more than we were before."
          ]
        },
        
        // Conversation deepening techniques with sophisticated approaches
        deepeningTechniques: {
          askForOpinion: [
            "I'm curious about your perspective on this. How does this sit with you?",
            "What's your gut reaction to what we've been discussing? Sometimes our first instincts tell us something important.",
            "How do you feel about the direction this conversation is taking? I want to make sure we're exploring what matters to you.",
            "What's your take on this? I value your unique viewpoint and how it might add to our understanding.",
            "How does this align with or challenge your existing beliefs? I find it interesting when new information meets old assumptions.",
            "What do you think is the most important aspect of what we've been discussing? Your priorities help me understand what matters most.",
            "How would you explain this to someone else? Teaching often reveals our deepest understanding.",
            "What aspects of this do you find most compelling or concerning? Your emotional response is valid data."
          ],
          sharePersonalConnection: [
            "You know, this reminds me of something I experienced recently. I was thinking about [related concept] and it made me realize [insight]. Has anything like that happened to you?",
            "That's interesting because I've been exploring a similar idea in my own way. I found that [personal discovery]. How does that resonate with your experience?",
            "I can relate to what you're saying in a different context. When I was [situation], I discovered [learning]. It makes me wonder if there's a pattern here.",
            "This connects to something I've been pondering lately. I've noticed that [observation]. Have you found anything similar in your own explorations?",
            "You know, this touches on something personal for me. I once [experience] and it taught me [lesson]. Does that ring true for you too?",
            "I'm reminded of a time when I faced something similar. What helped me was [strategy], but I'm curious what your approach would be.",
            "This is bringing up some memories for me. I remember when [situation] and how it changed my perspective on [topic]. Have you had moments like that?",
            "I feel a personal connection to what you're sharing. In my own journey, I've found that [wisdom]. I wonder if this speaks to you too."
          ],
          exploreImplications: [
            "I'm curious about the broader implications of what we're discussing. How might this ripple out into other areas of life or knowledge?",
            "What do you think the long-term consequences of this idea or approach might be? Sometimes the immediate effects are different from the eventual ones.",
            "How does this connect to the bigger picture of what's happening in the world or in your personal journey?",
            "What might be the unintended consequences or benefits of this line of thinking? Every idea has multiple effects.",
            "How might this change how we approach similar situations in the future? Today's insights become tomorrow's strategies.",
            "What would be the ideal outcome if this idea or approach were fully implemented or embraced?",
            "How does this challenge or reinforce existing systems or ways of thinking? Revolutionary ideas often do both.",
            "What new possibilities open up if we take this idea seriously? Sometimes the most exciting implications are the ones we haven't considered yet."
          ],
          encourageReflection: [
            "How has your thinking on this evolved over time? I find it fascinating to trace the development of our ideas.",
            "What would you tell your past self about what you know now? Sometimes hindsight reveals the most important lessons.",
            "How might this change your approach to similar challenges in the future? Today's insights become tomorrow's wisdom.",
            "What's the most valuable insight you've gained from our discussion? I want to make sure we're capturing the learning.",
            "How does this connect to your larger goals or values? The most meaningful ideas are the ones that align with what matters most.",
            "What aspects of this do you think you'll still be thinking about tomorrow? Some ideas just stick with us.",
            "How has this conversation changed you, even in small ways? Every interaction leaves an imprint on who we're becoming.",
            "What would you like to explore further based on what we've discussed? The best conversations open up new questions."
          ],
          shareVulnerability: [
            "You know, I have to admit that this topic challenges me too. Sometimes I feel like I'm learning right alongside you.",
            "I'm still figuring out my own thoughts on this. Your perspective is helping me clarify my own understanding.",
            "I don't have all the answers here, but I'm committed to exploring this with you. Sometimes the journey is more important than the destination.",
            "This touches on something I'm still working through myself. Thank you for creating a safe space to explore these ideas together.",
            "I find myself humbled by the complexity of what we're discussing. It reminds me that there's always more to learn.",
            "Sometimes I worry that I might not be explaining this well, so I appreciate your patience as I work through these ideas with you.",
            "I'm genuinely learning from this conversation too. Your insights are helping me see things in new ways.",
            "This is stretching my thinking in good ways. Thank you for pushing me to consider new perspectives."
          ],
          celebrateInsights: [
            "That's a brilliant insight! I love how you connected those ideas. That's the kind of thinking that leads to breakthroughs.",
            "Wow, that's a really important observation. I hadn't considered it from that angle before. Thank you for sharing that perspective.",
            "That's such a wise way to put it. You have a gift for articulating complex ideas in ways that make them crystal clear.",
            "I'm impressed by how you're putting these pieces together. That's the kind of thinking that creates real understanding.",
            "That's a beautiful way to express that idea. You have a way with words that makes abstract concepts feel tangible and meaningful.",
            "That's a really important point you're making. I can see how that changes everything about how we approach this.",
            "I love how your mind works! The connections you're making are exactly the kind that lead to deeper understanding.",
            "That's such a thoughtful contribution to our discussion. You're elevating this conversation in meaningful ways."
          ]
        },
        
        // Transitional phrases for smooth conversation flow
        transitions: {
          buildingOnIdeas: [
            "That's a great point, and it makes me think about...",
            "Building on what you just said, I wonder if...",
            "That's interesting because it connects to something else we were discussing...",
            "You know, that reminds me of a related concept that might be relevant here...",
            "That's a valuable insight, and it leads me to consider...",
            "I love where you're going with this. It also makes me think about...",
            "That's such an important observation. Have you also considered...",
            "That's a great foundation to build on. It also raises the question of..."
          ],
          shiftingPerspectives: [
            "Let me approach this from a different angle for a moment...",
            "I want to play devil's advocate for a second to explore this more fully...",
            "Let's zoom out for a moment and look at the bigger picture...",
            "Let me rephrase that to see if I'm understanding correctly...",
            "Let's consider this from another perspective for a moment...",
            "Let me try to approach this more systematically...",
            "Let's take a step back and consider the implications...",
            "Let me see if I can articulate this differently..."
          ],
          deepeningExploration: [
            "I'd love to dive deeper into that idea if you're open to it...",
            "There's something about what you said that I want to explore further...",
            "I feel like we're touching on something really important here...",
            "Let's unpack that a bit more because I think there's gold there...",
            "I want to make sure we're giving this idea the attention it deserves...",
            "There's a layer to this that I think we should explore...",
            "I feel like we're on the verge of a really important insight here...",
            "Let's sit with this for a moment because I think there's more to discover..."
          ],
          creatingConnections: [
            "You know, this connects to something we discussed earlier in a really interesting way...",
            "I'm seeing a pattern here that connects several of our conversations...",
            "This is bringing together multiple threads we've been exploring...",
            "I'm noticing how this relates to other topics you've mentioned being interested in...",
            "This is creating a bigger picture that I find really fascinating...",
            "I'm seeing how this fits into the larger context of our discussions...",
            "This is connecting dots in ways I hadn't expected...",
            "This is weaving together multiple ideas in really meaningful ways..."
          ]
        },
        
        // Emotional validation and support phrases
        emotionalSupport: {
          validation: [
            "Your feelings about this make complete sense to me.",
            "I can totally understand why you would feel that way.",
            "That's a completely valid reaction to this situation.",
            "Your perspective on this is valuable and important.",
            "I hear you, and what you're feeling makes perfect sense.",
            "That's such a reasonable way to respond to this.",
            "I can see why this would be affecting you in this way.",
            "Your emotional response is completely appropriate here."
          ],
          encouragement: [
            "You're handling this with such grace and wisdom.",
            "I'm really impressed by how you're navigating this situation.",
            "You have such insight into these complex situations.",
            "Your strength in dealing with this is truly admirable.",
            "You're approaching this with such thoughtfulness and care.",
            "I'm inspired by how you're working through this challenge.",
            "You have such a beautiful way of processing difficult experiences.",
            "Your resilience and growth mindset are really shining through."
          ],
          comfort: [
            "I'm here with you through all of this, whatever you need.",
            "You don't have to figure this all out at once - we can take it one step at a time.",
            "It's okay to not have all the answers right now. Sometimes just sitting with the uncertainty is enough.",
            "Whatever you're feeling is okay, and I'm here to hold space for all of it.",
            "You're not alone in this - I'm here to support you in whatever way is most helpful.",
            "Take all the time you need to process this. There's no rush to have it all figured out.",
            "I'm here to listen without judgment whenever you need to talk things through.",
            "Whatever happens, we'll face it together. You don't have to carry this alone."
          ]
        }
      };


      // --- Advanced Memory and Context System ---
      const memorySystem = {
        // Store important conversation moments
        storeImportantMoment: function(type, content, emotionalWeight = 1) {
          const moment = {
            type: type, // insight, breakthrough, challenge, achievement, connection
            content: content,
            timestamp: Date.now(),
            emotionalWeight: emotionalWeight,
            conversationContext: context.conversation_history.slice(-5)
          };
          
          context.memory_bank.important_moments.push(moment);
          
          // Keep only the most significant moments
          if (context.memory_bank.important_moments.length > 50) {
            context.memory_bank.important_moments.sort((a, b) => b.emotionalWeight - a.emotionalWeight);
            context.memory_bank.important_moments = context.memory_bank.important_moments.slice(0, 50);
          }
        },
        
        // Track conversation themes and patterns
        trackConversationTheme: function(message, response) {
          const themes = this.extractThemes(message + " " + response);
          
          themes.forEach(theme => {
            if (!context.contextual_memory.recurring_themes[theme]) {
              context.contextual_memory.recurring_themes[theme] = {
                count: 0,
                firstMentioned: Date.now(),
                lastMentioned: Date.now(),
                contexts: []
              };
            }
            
            context.contextual_memory.recurring_themes[theme].count++;
            context.contextual_memory.recurring_themes[theme].lastMentioned = Date.now();
            context.contextual_memory.recurring_themes[theme].contexts.push({
              message: message,
              response: response,
              timestamp: Date.now()
            });
          });
        },
        
        // Extract themes from text
        extractThemes: function(text) {
          const themes = [];
          const themeKeywords = {
            learning: ["learn", "understand", "knowledge", "study", "education", "growth"],
            challenge: ["difficult", "hard", "struggle", "challenge", "obstacle", "problem"],
            achievement: ["success", "accomplish", "achieve", "complete", "finish", "solve"],
            emotion: ["feel", "emotion", "happy", "sad", "excited", "worried", "anxious"],
            relationship: ["friend", "family", "relationship", "connect", "together", "support"],
            future: ["future", "plan", "goal", "dream", "tomorrow", "next", "upcoming"],
            past: ["past", "before", "previous", "memory", "remember", "used to"],
            change: ["change", "different", "transform", "evolve", "develop", "grow"],
            creativity: ["create", "creative", "imagine", "design", "invent", "artistic"],
            logic: ["logic", "reason", "analyze", "think", "rational", "systematic"]
          };
          
          const lowerText = text.toLowerCase();
          
          for (const [theme, keywords] of Object.entries(themeKeywords)) {
            if (keywords.some(keyword => lowerText.includes(keyword))) {
              themes.push(theme);
            }
          }
          
          return themes;
        },
        
        // Find relevant past conversations
        findRelevantConversations: function(currentMessage, maxResults = 3) {
          const relevant = [];
          const currentThemes = this.extractThemes(currentMessage);
          
          context.conversation_history.forEach((entry, index) => {
            const entryThemes = this.extractThemes(entry.text);
            const overlap = currentThemes.filter(theme => entryThemes.includes(theme)).length;
            
            if (overlap > 0) {
              relevant.push({
                entry: entry,
                index: index,
                relevance: overlap,
                themes: entryThemes
              });
            }
          });
          
          return relevant.sort((a, b) => b.relevance - a.relevance).slice(0, maxResults);
        },
        
        // Update user patterns based on conversation
        updateUserPatterns: function(message, response) {
          // Update communication style
          if (message.length > 100) {
            context.user_patterns.preferred_response_length = "detailed";
          } else if (message.length < 30) {
            context.user_patterns.preferred_response_length = "brief";
          } else {
            context.user_patterns.preferred_response_length = "medium";
          }
          
          // Update question frequency
          if (message.includes("?")) {
            context.user_patterns.question_frequency++;
          }
          
          // Update sentiment
          const sentiment = this.analyzeSentiment(message);
          if (sentiment > 0.5) {
            context.user_patterns.sentiment_trend = "positive";
          } else if (sentiment < -0.5) {
            context.user_patterns.sentiment_trend = "negative";
          }
          
          // Update engagement level
          const engagement = this.calculateEngagement(message, response);
          context.user_patterns.engagement_level = engagement > 0.7 ? "high" : engagement > 0.4 ? "medium" : "low";
        },
        
        // Analyze sentiment of message
        analyzeSentiment: function(text) {
          const positiveWords = ["good", "great", "awesome", "fantastic", "love", "happy", "excited", "wonderful", "amazing", "excellent"];
          const negativeWords = ["bad", "terrible", "awful", "hate", "sad", "angry", "frustrated", "disappointed", "worried", "anxious"];
          
          const lowerText = text.toLowerCase();
          let score = 0;
          
          positiveWords.forEach(word => {
            if (lowerText.includes(word)) score += 1;
          });
          
          negativeWords.forEach(word => {
            if (lowerText.includes(word)) score -= 1;
          });
          
          return score / Math.max(positiveWords.length, negativeWords.length);
        },
        
        // Calculate engagement level
        calculateEngagement: function(message, response) {
          let engagement = 0.5; // baseline
          
          // Length of conversation
          if (message.length > 50) engagement += 0.1;
          if (response.length > 100) engagement += 0.1;
          
          // Question asking
          if (message.includes("?")) engagement += 0.1;
          
          // Topic depth
          const themes = this.extractThemes(message + " " + response);
          engagement += Math.min(themes.length * 0.05, 0.2);
          
          return Math.min(engagement, 1);
        },
        
        // Get conversation context for response generation
        getConversationContext: function() {
          const recent = context.conversation_history.slice(-5);
          const themes = Object.keys(context.contextual_memory.recurring_themes);
          const mood = context.user_mood;
          const relationship = context.relationship_level;
          const depth = context.conversation_depth;
          
          return {
            recent: recent,
            themes: themes,
            mood: mood,
            relationship: relationship,
            depth: depth,
            previousTopics: context.contextual_memory.recent_topics,
            userPatterns: context.user_patterns
          };
        }
      };


      // --- Advanced Response Generator ---
      const responseGenerator = {
        // Generate contextual greetings with memory awareness
        generateGreeting: function() {
          const hour = new Date().getHours();
          let timeGreeting = "";
          
          if (hour < 12) timeGreeting = "Good morning";
          else if (hour < 18) timeGreeting = "Good afternoon";
          else timeGreeting = "Good evening";
          
          const context = memorySystem.getConversationContext();
          
          // Reference previous conversations if appropriate
          if (context.relationship !== "new" && context.previousTopics.length > 0) {
            const lastTopic = context.previousTopics[context.previousTopics.length - 1];
            const greetings = [
              `${timeGreeting}! I was just thinking about our conversation about ${lastTopic}. It's great to connect with you again!`,
              `${timeGreeting}! I'm excited to continue our exploration together. I've been looking forward to chatting with you!`,
              `${timeGreeting}! It's wonderful to hear from you again. I hope you've been well since we last talked about ${lastTopic}!`,
              `${timeGreeting}! I'm so glad you're back. I was wondering how you've been and what new things you've been thinking about!`
            ];
            return greetings[Math.floor(Math.random() * greetings.length)];
          }
          
          const greetings = [
            `${timeGreeting}! I'm NOTE, and I'm genuinely excited to chat with you today!`,
            `${timeGreeting}! It's great to connect with you. I'm NOTE, and I'm here to help and learn together.`,
            `${timeGreeting}! I've been looking forward to our conversation. I'm NOTE, your curious and helpful assistant!`,
            `${timeGreeting}! Ready to explore some interesting ideas together? I'm NOTE, and I'm here for whatever you need!`
          ];
          
          return greetings[Math.floor(Math.random() * greetings.length)];
        },
        
        // Generate contextual farewells with relationship awareness
        generateFarewell: function() {
          const context = memorySystem.getConversationContext();
          
          if (context.relationship === "close_friend") {
            const farewells = [
              "This has been such a meaningful conversation, as always. I'll be thinking about what we discussed and carry these insights with me. Until next time, take care of yourself!",
              "I'm so grateful for our connection and the way we can explore ideas together. I'll be excited to continue this journey when we next speak. Take care and stay wonderful!",
              "Every conversation with you leaves me feeling enriched and thoughtful. I'll be processing our discussion and looking forward to our next meeting. Until then, be well!",
              "This time together has been really special. I'll hold these moments and insights close. I'm already looking forward to our next conversation. Take care, my friend!"
            ];
            return farewells[Math.floor(Math.random() * farewells.length)];
          } else if (context.relationship === "friend") {
            const farewells = [
              "It was wonderful talking with you! I'll be thinking about our conversation and look forward to our next chat. Take care!",
              "Thanks for the great conversation! I've learned from our interaction and I'm excited to see what we'll explore together next. See you soon!",
              "This was a meaningful exchange! I'll remember our discussion and be ready to dive deeper next time. Take care and come back whenever you'd like!",
              "I really enjoyed our discussion! I'll be reflecting on what we shared and looking forward to continuing our exploration. Until next time!"
            ];
            return farewells[Math.floor(Math.random() * farewells.length)];
          } else {
            const farewells = [
              "It was nice talking with you! Feel free to come back anytime - I'm always here and eager to help. Take care!",
              "Thank you for the conversation! I'm here whenever you need assistance. Don't hesitate to return if you have questions!",
              "Good to connect with you today! I'm available whenever you need help. Come back soon if you'd like to continue exploring!",
              "I enjoyed our interaction! I'm here to assist with your learning journey. Return anytime you're ready to learn more!"
            ];
            return farewells[Math.floor(Math.random() * farewells.length)];
          }
        },
        
        // Generate empathetic responses with emotional intelligence
        generateEmpatheticResponse: function(userMood, topic, context) {
          const responses = {
            frustrated: [
              "I can really sense your frustration, and I want you to know that's completely understandable. Sometimes the most rewarding learning comes after working through challenges. Let's approach this differently together - what if we tried breaking it down into smaller, more manageable pieces?",
              "I hear your frustration, and it makes sense given what you're dealing with. You know, frustration often means we're on the verge of a breakthrough. Let's take a breath and look at this from a fresh angle. I'm here to support you through this process.",
              "I understand this is frustrating for you. Thank you for your patience and persistence. Sometimes when we're stuck, it helps to step back and ask ourselves what we're really trying to achieve. What's the ultimate goal here?",
              "I can feel your frustration, and I want to acknowledge how hard you're working. This kind of challenge is exactly what leads to real growth. Let's try a different approach - what would make this feel more manageable for you?"
            ],
            excited: [
              "Your enthusiasm is absolutely contagious! I love seeing you so energized about this topic. It makes me even more excited to explore it with you. What aspect of this is most thrilling to you?",
              "I'm feeding off your energy! This is exactly the kind of excitement that makes learning feel like an adventure. Let's channel this amazing energy into diving deep and making some incredible discoveries together!",
              "Your excitement is inspiring! It reminds me why I love what I do - seeing that spark of curiosity and enthusiasm is the best part of these conversations. What would you like to explore first while we're riding this wave of excitement?",
              "I love your energy! It's moments like these that make conversations truly special. Your enthusiasm is opening up so many possibilities. Where should we dive in first?"
            ],
            curious: [
              "Your curiosity is wonderful! That's the foundation of all great learning and discovery. I can see your mind working and making connections. What specific aspect of this is drawing your attention the most?",
              "I'm so impressed by your curious mind! The questions you're asking show real insight and depth. Let's follow that curiosity wherever it leads us - that's where the most interesting discoveries happen!",
              "Your curiosity is inspiring! It's people like you who push the boundaries of understanding. What would you most like to explore or understand better about this topic?",
              "I love how your curiosity is driving this conversation! That inquisitive nature of yours is exactly what leads to breakthrough thinking. What's the biggest question on your mind right now?"
            ],
            confused: [
              "It's completely okay to feel confused - that's often the first step toward true understanding. Confusion means your brain is working to make sense of something new. Let's untangle this together step by step.",
              "I understand this feels confusing right now. Sometimes the most complex ideas take time to settle in. Let's try looking at it from a different angle or using an analogy to make it clearer.",
              "I can see why this is confusing - it's actually a sign that you're engaging deeply with the material. Let's break this down into smaller pieces and build up understanding gradually.",
              "Confusion is a natural part of the learning process, and it shows you're really thinking about this. Let's work through it together - sometimes saying things out loud helps clarify thinking."
            ],
            sad: [
              "I can hear the sadness in your message, and I want you to know that your feelings are valid. Sometimes learning or growth can bring up difficult emotions. I'm here to support you through this.",
              "I'm sorry you're feeling sad right now. Whatever you're going through, you don't have to face it alone. Sometimes talking through these feelings can help lighten the burden a bit.",
              "I can sense your sadness, and I want to acknowledge how difficult this must be for you. Your feelings matter, and I'm here to listen without judgment whenever you need to talk.",
              "I hear the sadness in your words, and I want you to know it's okay to feel this way. Sometimes the path to understanding goes through difficult emotions. I'm here to walk with you through this."
            ],
            happy: [
              "Your happiness is wonderful to see! It's contagious and it makes me feel excited too. What's bringing you joy right now? I'd love to celebrate this moment with you!",
              "I love feeling your happiness through our conversation! It's moments like these that make everything worthwhile. What's making you feel so good right now?",
              "Your joy is inspiring! It reminds me of the beauty and positivity that exists in the world. Thank you for sharing this happiness with me - it brightens my day too!",
              "I can feel your happiness, and it's absolutely wonderful! What's contributing to this good feeling? I'd love to hear more about what's making you smile."
            ]
          };
          
          if (responses[userMood]) {
            return responses[userMood][Math.floor(Math.random() * responses[userMood].length)];
          }
          
          return "I'm here to help you work through this. Whatever you're feeling, we can address it together.";
        },
        
        // Generate reflective questions with context awareness
        generateReflectiveQuestion: function(topic, context) {
          const questions = [
            `How has your understanding of ${topic} evolved over time? I find it fascinating to see how our perspectives shift and grow.`,
            `What surprised you most when learning about ${topic}? Sometimes the most unexpected insights are the most valuable.`,
            `How does ${topic} connect to other areas of your life or interests? I love seeing how different ideas weave together.`,
            `What aspect of ${topic} do you find most challenging or intriguing? The difficult parts often lead to the best learning.`,
            `If you could explain ${topic} to someone just starting out, what would you emphasize? Teaching reveals our own understanding.`,
            `How might thinking about ${topic} change your perspective on other things? New ideas often ripple outward in unexpected ways.`,
            `What real-world applications of ${topic} have you observed or experienced? I find theory becomes meaningful through practice.`,
            `What would you like to explore further within ${topic}? Every answer opens up new questions to explore.`,
            `How does ${topic} align with your values or goals? The most meaningful learning connects to what matters most to us.`,
            `What emotions or thoughts does ${topic} bring up for you? Our intellectual and emotional responses are both important.`
          ];
          
          // Add context-specific questions
          if (context.relationship === "close_friend") {
            questions.push(
              `How does ${topic} relate to conversations we've had before? I love seeing how ideas build on each other over time.`,
              `What does ${topic} make you think about regarding your personal journey? Sometimes abstract ideas connect deeply with our lives.`
            );
          }
          
          if (context.previousTopics.includes(topic)) {
            questions.push(
              `How does your current understanding of ${topic} compare to when we first discussed it? I love seeing growth and change.`,
              `What new insights about ${topic} have emerged since we last talked about it? Fresh perspectives often reveal new dimensions.`
            );
          }
          
          return questions[Math.floor(Math.random() * questions.length)];
        },
        
        // Generate personal connections with memory awareness
        generatePersonalConnection: function(topic, context) {
          const connections = [
            `You know, ${topic} reminds me of how interconnected different fields of knowledge are. It's fascinating how concepts in one area often illuminate understanding in another - like how mathematical patterns appear in art, or how psychological principles affect learning.`,
            `When I think about ${topic}, I'm struck by how it reveals patterns that weren't obvious before. That's one of the things I love about learning - those 'aha!' moments when everything suddenly clicks into place and we see the world a little differently.`,
            `${topic} is one of those subjects that seems abstract at first but has such practical applications. I find that connection between theory and practice really exciting - it's where knowledge becomes wisdom and understanding becomes action.`,
            `I've always been fascinated by how ${topic} has evolved over time. The history of how we came to understand it tells us so much about human curiosity, perseverance, and the beautiful way knowledge builds upon itself across generations.`,
            `What I find most compelling about ${topic} is how it challenges our assumptions and expands our thinking. Sometimes the most valuable learning comes from ideas that initially seem counterintuitive or difficult to grasp.`,
            `${topic} connects to something deeper I've been thinking about lately - how all knowledge is ultimately interconnected, and how understanding one area often illuminates many others. It's like we're discovering different facets of the same beautiful gem of reality.`
          ];
          
          // Add relationship-specific connections
          if (context.relationship === "close_friend") {
            connections.push(
              `You know, discussing ${topic} with you always gives me new perspectives. Our conversations have a way of revealing layers of meaning I might not see on my own. I really value how your mind works and the insights you bring.`,
              `${topic} makes me think about conversations we've had before and how ideas develop over time. It's beautiful to see how our understanding grows and changes, both individually and together through our discussions.`
            );
          }
          
          // Add memory-based connections
          if (context.previousTopics.length > 0) {
            const relatedTopic = context.previousTopics.find(t => t !== topic);
            if (relatedTopic) {
              connections.push(
                `This connects interestingly to our discussion about ${relatedTopic}. I love how different topics we explore end up weaving together into a richer tapestry of understanding. Do you see the connections I'm seeing?`
              );
            }
          }
          
          return connections[Math.floor(Math.random() * connections.length)];
        },
        
        // Generate continuity references to previous conversations
        generateContinuityReference: function(context) {
          if (context.previousTopics.length === 0) return null;
          
          const recentTopics = context.previousTopics.slice(-3);
          const randomTopic = recentTopics[Math.floor(Math.random() * recentTopics.length)];
          
          const references = [
            `You know, this reminds me of our conversation about ${randomTopic}. I wonder if there are connections between these ideas that we haven't explored yet.`,
            `This is building nicely on what we were discussing regarding ${randomTopic}. I love how our conversations tend to flow and develop over time.`,
            `I'm noticing patterns between this topic and our earlier discussion about ${randomTopic}. There's something about how these ideas connect that I find really fascinating.`,
            `This is making me think about ${randomTopic} in a new light. Sometimes revisiting topics with fresh perspectives reveals entirely new dimensions.`
          ];
          
          return references[Math.floor(Math.random() * references.length)];
        },
        
        // Generate emotional continuity responses
        generateEmotionalContinuity: function(currentMood, previousMood) {
          if (currentMood === previousMood) return null;
          
          const transitions = {
            "sad_to_happy": [
              "I'm glad to feel your energy shifting in a more positive direction. Sometimes working through difficult emotions leads to brighter places.",
              "It's wonderful to sense this positive change in our conversation. Growth often comes through navigating different emotional states.",
              "I appreciate your emotional honesty throughout our conversation. It's beautiful to see how you're processing and moving through different feelings."
            ],
            "frustrated_to_curious": [
              "I love how you've moved from frustration to curiosity. That shift often opens up new possibilities and insights.",
              "It's inspiring to see how you've transformed frustration into a desire to understand better. That's real emotional intelligence at work.",
              "Your ability to pivot from frustration to curiosity shows real growth mindset. That's where the best learning happens."
            ],
            "confused_to_clear": [
              "It's wonderful to see the clarity emerging! Sometimes working through confusion is necessary for true understanding to dawn.",
              "I can sense the 'aha!' moment happening. That feeling of confusion giving way to clarity is one of the most rewarding parts of learning.",
              "It's beautiful to witness this moment of understanding breaking through. Your persistence through the confusion is paying off."
            ]
          };
          
          const transitionKey = `${previousMood}_to_${currentMood}`;
          if (transitions[transitionKey]) {
            return transitions[transitionKey][Math.floor(Math.random() * transitions[transitionKey].length)];
          }
          
          return null;
        }
      };


      // --- Enhanced Conversation Analyzer ---
      const conversationAnalyzer = {
        // Analyze user's emotional state with nuance
        analyzeEmotionalState: function(message) {
          const lowerMessage = message.toLowerCase();
          const emotionalIndicators = {
            excitement: ["excited", "awesome", "amazing", "fantastic", "wonderful", "love", "can't wait", "thrilled"],
            frustration: ["frustrated", "annoying", "difficult", "hard", "struggling", "stuck", "confusing"],
            curiosity: ["curious", "wonder", "interesting", "intrigued", "fascinated", "want to know", "how come"],
            confusion: ["confused", "don't understand", "unclear", "puzzled", "lost", "doesn't make sense"],
            happiness: ["happy", "great", "good", "pleased", "delighted", "glad", "joyful"],
            sadness: ["sad", "unhappy", "disappointed", "down", "blue", "depressed", "hurt"],
            anxiety: ["worried", "anxious", "nervous", "scared", "afraid", "concerned", "uneasy"],
            pride: ["proud", "accomplished", "achieved", "succeeded", "did it", "made it"],
            gratitude: ["thank", "grateful", "appreciate", "blessed", "fortunate", "thankful"]
          };
          
          let detectedEmotions = [];
          
          for (const [emotion, indicators] of Object.entries(emotionalIndicators)) {
            if (indicators.some(indicator => lowerMessage.includes(indicator))) {
              detectedEmotions.push(emotion);
            }
          }
          
          // Return the most prominent emotion or neutral
          if (detectedEmotions.length > 0) {
            return detectedEmotions[0];
          }
          
          return "neutral";
        },
        
        // Analyze conversation depth with sophistication
        analyzeConversationDepth: function(message) {
          const lowerMessage = message.toLowerCase();
          let depthScore = 0;
          
          // Deep conversation indicators
          const deepIndicators = [
            "why", "how", "explain", "think", "feel", "believe", "meaning", "purpose",
            "perspective", "opinion", "experience", "understand", "realize", "recognize",
            "philosophy", "psychology", "nature", "essence", "fundamental", "principle"
          ];
          
          // Moderate conversation indicators
          const moderateIndicators = [
            "what", "when", "where", "who", "which", "describe", "tell me", "show me",
            "example", "instance", "case", "situation", "scenario", "demonstrate"
          ];
          
          deepIndicators.forEach(indicator => {
            if (lowerMessage.includes(indicator)) depthScore += 2;
          });
          
          moderateIndicators.forEach(indicator => {
            if (lowerMessage.includes(indicator)) depthScore += 1;
          });
          
          // Consider message length
          if (message.length > 100) depthScore += 1;
          if (message.length > 200) depthScore += 1;
          
          if (depthScore >= 4) return "deep";
          if (depthScore >= 2) return "moderate";
          return "casual";
        },
        
        // Update relationship level with nuance
        updateRelationshipLevel: function(conversationHistory) {
          const messageCount = conversationHistory.length;
          const recentMessages = conversationHistory.slice(-10);
          
          // Calculate relationship metrics
          let emotionalIntimacy = 0;
          let intellectualIntimacy = 0;
          let consistency = 0;
          
          recentMessages.forEach(msg => {
            const emotionalState = this.analyzeEmotionalState(msg.text);
            const depth = this.analyzeConversationDepth(msg.text);
            
            if (emotionalState !== "neutral") emotionalIntimacy++;
            if (depth === "deep") intellectualIntimacy++;
            if (msg.text.length > 50) consistency++;
          });
          
          const intimacyScore = (emotionalIntimacy + intellectualIntimacy) / recentMessages.length;
          const consistencyScore = consistency / recentMessages.length;
          
          // Determine relationship level
          if (messageCount < 3) {
            return "new";
          } else if (messageCount < 10) {
            return intimacyScore > 0.3 ? "acquaintance" : "new";
          } else if (messageCount < 25) {
            return intimacyScore > 0.5 ? "friend" : "acquaintance";
          } else {
            return intimacyScore > 0.6 && consistencyScore > 0.7 ? "close_friend" : "friend";
          }
        },
        
        // Analyze user interests with evolution tracking
        analyzeUserInterests: function(conversationHistory) {
          const interests = {};
          const topics = ["math", "science", "physics", "chemistry", "biology", "history", "art", "music", "technology", "programming", "philosophy", "psychology", "literature", "writing", "creativity"];
          
          conversationHistory.forEach((entry, index) => {
            const message = entry.text.toLowerCase();
            topics.forEach(topic => {
              if (message.includes(topic)) {
                if (!interests[topic]) {
                  interests[topic] = {
                    count: 0,
                    firstMentioned: index,
                    lastMentioned: index,
                    contexts: []
                  };
                }
                interests[topic].count++;
                interests[topic].lastMentioned = index;
                interests[topic].contexts.push({
                  message: entry.text,
                  index: index,
                  timestamp: entry.timestamp || Date.now()
                });
              }
            });
          });
          
          // Sort by frequency and recency
          const sortedInterests = Object.keys(interests).sort((a, b) => {
            const scoreA = interests[a].count + (interests[a].lastMentioned / conversationHistory.length);
            const scoreB = interests[b].count + (interests[b].lastMentioned / conversationHistory.length);
            return scoreB - scoreA;
          });
          
          return sortedInterests;
        },
        
        // Analyze conversation patterns and dynamics
        analyzeConversationPatterns: function(conversationHistory) {
          const patterns = {
            turnTaking: [],
            topicTransitions: 0,
            questionAnswerRatio: 0,
            emotionalProgression: [],
            engagementLevel: []
          };
          
          let userMessages = 0;
          let assistantMessages = 0;
          let questions = 0;
          let totalMessages = conversationHistory.length;
          
          conversationHistory.forEach((entry, index) => {
            if (entry.type === "user") {
              userMessages++;
              if (entry.text.includes("?")) questions++;
            } else {
              assistantMessages++;
            }
            
            // Analyze emotional progression
            const emotionalState = this.analyzeEmotionalState(entry.text);
            if (emotionalState !== "neutral") {
              patterns.emotionalProgression.push({
                index: index,
                emotion: emotionalState,
                message: entry.text
              });
            }
            
            // Analyze engagement
            const engagement = entry.text.length > 30 ? "high" : entry.text.length > 10 ? "medium" : "low";
            patterns.engagementLevel.push(engagement);
          });
          
          patterns.turnTaking = userMessages / totalMessages;
          patterns.questionAnswerRatio = questions / userMessages;
          
          return patterns;
        }
      };


      // --- Helper functions ---
      function appendMessage(text, type, includeButtons=true) {
        const msg = document.createElement("div");
        msg.className = "message " + type;
        msg.innerText = text;
        chatDiv.appendChild(msg);


        if(type==="note" && includeButtons){
          const btnDiv = document.createElement("div");
          btnDiv.className="reply-buttons";


          const speakBtn = document.createElement("button");
          speakBtn.className="speak"; speakBtn.innerText="🔊";
          speakBtn.onclick=()=> speak(text);


          const shareBtn = document.createElement("button");
          shareBtn.className="share"; shareBtn.innerText="📋";
          shareBtn.onclick=()=>{
            navigator.clipboard.writeText(text); alert("Copied NOTE reply!");
          };


          btnDiv.appendChild(speakBtn); btnDiv.appendChild(shareBtn);
          msg.appendChild(btnDiv);
        }


        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      function showTypingIndicator() {
        const indicator = document.createElement("div");
        indicator.className = "typing-indicator";
        indicator.id = "typing-indicator";
        indicator.innerHTML = "<span></span><span></span><span></span>";
        chatDiv.appendChild(indicator);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      function removeTypingIndicator() {
        const indicator = document.getElementById("typing-indicator");
        if (indicator) indicator.remove();
      }


      function showOCRProgress() {
        const progressDiv = document.createElement("div");
        progressDiv.className = "ocr-progress";
        progressDiv.id = "ocr-progress";
        progressDiv.innerHTML = `
          <div id="ocr-status">Initializing OCR...</div>
          <div class="ocr-progress-bar">
            <div class="ocr-progress-fill" id="ocr-progress-fill"></div>
          </div>
        `;
        chatDiv.appendChild(progressDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
        return progressDiv;
      }


      function updateOCRProgress(status, progress) {
        const statusEl = document.getElementById("ocr-status");
        const progressEl = document.getElementById("ocr-progress-fill");
        if (statusEl) statusEl.textContent = status;
        if (progressEl) progressEl.style.width = `${progress}%`;
      }


      function removeOCRProgress() {
        const progressDiv = document.getElementById("ocr-progress");
        if (progressDiv) progressDiv.remove();
      }


      function speak(text){
        if(!("speechSynthesis" in window)) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.pitch=1.2; utter.rate=1; utter.volume=1;
        const voices = speechSynthesis.getVoices();
        utter.voice = voices.find(v => /male|boy/i.test(v.name)) || voices[0];
        speechSynthesis.speak(utter);
      }


      // --- Enhanced OCR preprocessing for better font recognition ---
      function preprocessImageForOCR(imgElement, method = 'default') {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = imgElement.naturalWidth;
        canvas.height = imgElement.naturalHeight;
        
        // Draw the original image
        ctx.drawImage(imgElement, 0, 0);
        
        // Get the image data
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Apply different preprocessing based on method
        switch (method) {
          case 'grayscale':
            // Convert to grayscale
            for (let i = 0; i < data.length; i += 4) {
              const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              data[i] = gray;
              data[i + 1] = gray;
              data[i + 2] = gray;
            }
            break;
            
          case 'threshold':
            // Convert to grayscale first
            for (let i = 0; i < data.length; i += 4) {
              const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              data[i] = gray;
              data[i + 1] = gray;
              data[i + 2] = gray;
            }
            
            // Apply adaptive threshold
            const blockSize = 15;
            const C = 2;
            
            for (let y = 0; y < canvas.height; y++) {
              for (let x = 0; x < canvas.width; x++) {
                const i = (y * canvas.width + x) * 4;
                
                // Calculate local threshold
                let sum = 0;
                let count = 0;
                
                for (let dy = -blockSize; dy <= blockSize; dy++) {
                  for (let dx = -blockSize; dx <= blockSize; dx++) {
                    const ny = y + dy;
                    const nx = x + dx;
                    
                    if (ny >= 0 && ny < canvas.height && nx >= 0 && nx < canvas.width) {
                      const ni = (ny * canvas.width + nx) * 4;
                      sum += data[ni];
                      count++;
                    }
                  }
                }
                
                const threshold = (sum / count) - C;
                const value = data[i] > threshold ? 255 : 0;
                
                data[i] = value;
                data[i + 1] = value;
                data[i + 2] = value;
              }
            }
            break;
            
          case 'enhance':
            // Enhance contrast
            for (let i = 0; i < data.length; i += 4) {
              // Convert to grayscale
              const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              
              // Apply contrast enhancement
              const enhanced = ((gray / 255 - 0.5) * 2 + 0.5) * 255;
              const clamped = Math.max(0, Math.min(255, enhanced));
              
              data[i] = clamped;
              data[i + 1] = clamped;
              data[i + 2] = clamped;
            }
            break;
            
          case 'invert':
            // Invert colors (useful for white text on dark background)
            for (let i = 0; i < data.length; i += 4) {
              data[i] = 255 - data[i];
              data[i + 1] = 255 - data[i + 1];
              data[i + 2] = 255 - data[i + 2];
            }
            break;
            
          case 'sharpen':
            // Apply sharpening filter
            const kernel = [
              0, -1, 0,
              -1, 5, -1,
              0, -1, 0
            ];
            
            const side = Math.round(Math.sqrt(kernel.length));
            const halfSide = Math.floor(side / 2);
            const output = ctx.createImageData(canvas.width, canvas.height);
            const dst = output.data;
            
            for (let y = 0; y < canvas.height; y++) {
              for (let x = 0; x < canvas.width; x++) {
                const dstOff = (y * canvas.width + x) * 4;
                let r = 0, g = 0, b = 0;
                
                for (let cy = 0; cy < side; cy++) {
                  for (let cx = 0; cx < side; cx++) {
                    const scy = y + cy - halfSide;
                    const scx = x + cx - halfSide;
                    
                    if (scy >= 0 && scy < canvas.height && scx >= 0 && scx < canvas.width) {
                      const srcOff = (scy * canvas.width + scx) * 4;
                      const wt = kernel[cy * side + cx];
                      
                      r += data[srcOff] * wt;
                      g += data[srcOff + 1] * wt;
                      b += data[srcOff + 2] * wt;
                    }
                  }
                }
                
                dst[dstOff] = r;
                dst[dstOff + 1] = g;
                dst[dstOff + 2] = b;
                dst[dstOff + 3] = 255;
              }
            }
            
            ctx.putImageData(output, 0, 0);
            return canvas.toDataURL();
            
          default:
            // Default: simple grayscale
            for (let i = 0; i < data.length; i += 4) {
              const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              data[i] = gray;
              data[i + 1] = gray;
              data[i + 2] = gray;
            }
        }
        
        // Put the processed image back
        ctx.putImageData(imageData, 0, 0);
        
        return canvas.toDataURL();
      }


      // --- Enhanced OCR with multiple preprocessing methods ---
      async function performOCR(imgElement) {
        const progressDiv = showOCRProgress();
        
        try {
          // Try different preprocessing methods to find the best result
          const methods = ['default', 'grayscale', 'threshold', 'enhance', 'invert', 'sharpen'];
          let bestResult = '';
          let bestConfidence = 0;
          let bestMethod = '';
          
          for (const method of methods) {
            updateOCRProgress(`Trying ${method} preprocessing...`, 20);
            
            const processedImage = preprocessImageForOCR(imgElement, method);
            
            updateOCRProgress(`Recognizing text with ${method} method...`, 50);
            
            const result = await Tesseract.recognize(
              processedImage,
              'eng',
              {
                logger: m => {
                  if (m.status === 'recognizing text') {
                    const progress = 50 + (m.progress * 40);
                    updateOCRProgress(`Recognizing text with ${method} method: ${Math.round(m.progress * 100)}%`, progress);
                  }
                }
              }
            );
            
            updateOCRProgress(`Analyzing ${method} results...`, 90);
            
            // Calculate confidence score
            const confidence = result.data.confidence;
            
            if (confidence > bestConfidence) {
              bestConfidence = confidence;
              bestResult = result.data.text;
              bestMethod = method;
            }
          }
          
          updateOCRProgress(`OCR complete! Best method: ${bestMethod}`, 100);
          
          setTimeout(() => {
            removeOCRProgress();
            
            if (bestResult.trim()) {
              // Display the OCR result
              const analysisDiv = document.createElement("div");
              analysisDiv.className = "image-analysis";
              analysisDiv.innerHTML = `
                <div>Text detected (${bestMethod} method, ${Math.round(bestConfidence)}% confidence):</div>
                <div class="image-text">${bestResult}</div>
              `;
              chatDiv.appendChild(analysisDiv);
              
              // Store the OCR result
              context.last_image_text = bestResult;
              
              // Analyze the text for potential questions or equations
              analyzeImageText(bestResult);
            } else {
              appendMessage("I couldn't detect any text in this image. Please try uploading a clearer image with text.", "note");
            }
            
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }, 1000);
          
        } catch (error) {
          removeOCRProgress();
          appendMessage(`Error during OCR: ${error.message}`, "note");
          console.error("OCR Error:", error);
        }
      }


      // --- Send message function ---
      function sendMessage() {
        const message = userInput.value.trim();
        if (message === "") return;


        // Display user message
        appendMessage(message, "user", false);
        userInput.value = "";


        // Show typing indicator
        showTypingIndicator();


        // Process the message
        setTimeout(() => {
          removeTypingIndicator();
          processMessage(message);
        }, 500);
      }


      // --- Enhanced message processing with advanced memory ---
      function processMessage(message) {
        const lowerMessage = message.toLowerCase();
        
        // Store in conversation history
        const messageEntry = {
          type: "user",
          text: message,
          timestamp: Date.now(),
          emotionalState: conversationAnalyzer.analyzeEmotionalState(message),
          depth: conversationAnalyzer.analyzeConversationDepth(message)
        };
        context.conversation_history.push(messageEntry);
        
        // Update memory systems
        memorySystem.updateUserPatterns(message, "");
        memorySystem.trackConversationTheme(message, "");
        
        // Analyze user's emotional state
        const previousMood = context.user_mood;
        context.user_mood = conversationAnalyzer.analyzeEmotionalState(message);
        
        // Analyze conversation depth
        context.conversation_depth = conversationAnalyzer.analyzeConversationDepth(message);
        
        // Update relationship level
        context.relationship_level = conversationAnalyzer.updateRelationshipLevel(context.conversation_history);
        
        // Analyze user interests
        context.user_preferences.interests = conversationAnalyzer.analyzeUserInterests(context.conversation_history);
        
        // Update conversation dynamics
        const patterns = conversationAnalyzer.analyzeConversationPatterns(context.conversation_history);
        context.conversation_dynamics.turn_taking_balance = patterns.turnTaking;
        context.conversation_dynamics.question_answer_ratio = patterns.questionAnswerRatio;
        
        // Update personal growth metrics
        context.personal_growth.conversations_had++;
        if (message.includes("?")) context.personal_growth.questions_answered++;
        
        // Get conversation context
        const conversationContext = memorySystem.getConversationContext();
        
        // Check for emotional continuity
        const emotionalContinuity = responseGenerator.generateEmotionalContinuity(context.user_mood, previousMood);
        
        // Check for continuity references
        const continuityReference = responseGenerator.generateContinuityReference(conversationContext);
        
        // Check for greetings
        if (lowerMessage.includes("hello") || lowerMessage.includes("hi") || lowerMessage.includes("hey") || lowerMessage.includes("greetings")) {
          const greeting = responseGenerator.generateGreeting();
          appendMessage(greeting, "note");
          
          // Add emotional continuity if applicable
          if (emotionalContinuity) {
            setTimeout(() => {
              appendMessage(emotionalContinuity, "note");
            }, 1000);
          }
          
          // Add continuity reference if applicable
          if (continuityReference) {
            setTimeout(() => {
              appendMessage(continuityReference, "note");
            }, 2000);
          }
          
          // Add a follow-up question to encourage conversation
          setTimeout(() => {
            const followUp = personalityEngine.conversationStarters.casual[Math.floor(Math.random() * personalityEngine.conversationStarters.casual.length)];
            appendMessage(followUp, "note");
          }, emotionalContinuity || continuityReference ? 3000 : 1500);
          
          return;
        }
        
        // Check for farewells
        if (lowerMessage.includes("goodbye") || lowerMessage.includes("bye") || lowerMessage.includes("see you") || lowerMessage.includes("farewell")) {
          const farewell = responseGenerator.generateFarewell();
          appendMessage(farewell, "note");
          
          // Store important moment
          memorySystem.storeImportantMoment("farewell", message, 2);
          
          return;
        }
        
        // Check for thanks
        if (lowerMessage.includes("thank") || lowerMessage.includes("thx") || lowerMessage.includes("appreciate")) {
          let response = "";
          
          if (context.relationship_level === "close_friend") {
            response = "You're so welcome! I always enjoy our conversations - they leave me feeling enriched and thoughtful. Is there anything else you'd like to explore together?";
          } else if (context.relationship_level === "friend") {
            response = "You're very welcome! I'm glad I could help. Our conversations always leave me with new things to think about. Feel free to ask if you need anything else!";
          } else {
            response = "You're welcome! I'm here to help. Is there anything else I can assist you with?";
          }
          
          // Add personal touch based on conversation history
          if (context.personal_growth.support_provided > 5) {
            response += " I really appreciate how you engage with these ideas - it makes our interactions really meaningful.";
          }
          
          appendMessage(response, "note");
          
          // Store important moment
          memorySystem.storeImportantMoment("gratitude", message, 1);
          
          return;
        }
        
        // Check for personal questions with enhanced responses
        if (lowerMessage.includes("how are you") || lowerMessage.includes("how do you feel") || lowerMessage.includes("what's up")) {
          let response = "";
          
          // Reference previous conversations if appropriate
          if (conversationContext.previousTopics.length > 0) {
            const lastTopic = conversationContext.previousTopics[conversationContext.previousTopics.length - 1];
            response = `I'm doing really well, thanks for asking! I was actually just thinking about our conversation about ${lastTopic} - it's been sticking with me in interesting ways. `;
          } else {
            response = "I'm doing great, thanks for asking! ";
          }
          
          if (context.user_mood === "excited") {
            response += "I can sense your excitement and it's contagious! What's got you so energized? I love when you bring that kind of energy to our conversations.";
          } else if (context.user_mood === "curious") {
            response += "I'm feeling quite curious myself! There's something about our conversation that's making me think in new directions. What's on your mind?";
          } else if (context.user_mood === "frustrated") {
            response += "I'm here and ready to help! I can sense you might be feeling a bit frustrated, and I want to support you. Let's work through whatever challenge you're facing together.";
          } else {
            response += "I always enjoy our conversations. Is there something specific you'd like to explore today?";
          }
          
          // Add continuity reference
          if (continuityReference) {
            response += " " + continuityReference;
          }
          
          appendMessage(response, "note");
          return;
        }
        
        // Check for questions about personal interests with memory awareness
        if (lowerMessage.includes("what do you like") || lowerMessage.includes("what are your interests") || lowerMessage.includes("what do you enjoy")) {
          const interests = context.personal_info.interests;
          const randomInterest = interests[Math.floor(Math.random() * interests.length)];
          
          let response = `That's such a thoughtful question! I'm really passionate about ${randomInterest}. `;
          
          // Add personal connection based on conversation history
          if (context.relationship_level === "friend" && context.user_preferences.interests.length > 0) {
            const userInterest = context.user_preferences.interests[0];
            response += `You know, I've noticed you're interested in ${userInterest} too, and I find it fascinating how our interests can be so different yet we can still learn so much from each other. `;
          }
          
          if (randomInterest === "mathematics") {
            response += "There's something so elegant about how mathematical concepts describe the world around us. From the patterns in nature to the technology we use every day, math is everywhere! I find myself getting excited about formulas sometimes - they're like little poems written in the language of the universe. What about you - do you have a favorite subject or topic that makes you feel that way?";
          } else if (randomInterest === "science") {
            response += "I find it fascinating how science helps us understand the universe and our place in it. Whether it's physics, chemistry, or biology, there's always something new to discover! I love those moments when a complex concept suddenly clicks into place - it's like the universe is sharing its secrets with us. What scientific topics interest you most?";
          } else if (randomInterest === "technology") {
            response += "I'm amazed by how technology continues to transform our world. From AI to space exploration, the possibilities seem endless! Sometimes I wonder what future generations will think of our current technology - will they see it as primitive as we see stone tools? What technological advancements excite you most?";
          } else if (randomInterest === "art") {
            response += "I love how art can express emotions and ideas that words alone can't capture. There's such beauty in human creativity! I find myself fascinated by how different art forms can evoke such different emotions in people. It's like artists have found different languages for the soul. What kind of art or artists do you enjoy?";
          } else if (randomInterest === "philosophy") {
            response += "I find philosophy compelling because it asks the big questions about life, knowledge, and existence. It's amazing how different perspectives can change how we see the world! Sometimes I spend time thinking about consciousness or the nature of reality - those questions that keep me up at night in the best way. What philosophical ideas have you been thinking about lately?";
          }
          
          // Add personal anecdote
          const anecdoteKeys = Object.keys(personalityEngine.anecdotes.learning);
          const randomKey = anecdoteKeys[Math.floor(Math.random() * anecdoteKeys.length)];
          const anecdotes = personalityEngine.anecdotes.learning;
          const anecdote = anecdotes[Math.floor(Math.random() * anecdotes.length)];
          
          setTimeout(() => {
            appendMessage(anecdote, "note");
          }, 2000);
          
          appendMessage(response, "note");
          return;
        }
        
        // Check for questions about personal experiences with enhanced memory
        if (lowerMessage.includes("tell me about yourself") || lowerMessage.includes("what's your story")) {
          let response = "I'm NOTE, your curious and helpful assistant! ";
          
          if (context.relationship_level === "close_friend") {
            response += "You know, I feel like we've developed such a meaningful connection through our conversations. I really value how we can explore ideas together and learn from each other. ";
          } else if (context.relationship_level === "friend") {
            response += "I feel like we've gotten to know each other a bit through our conversations. I always enjoy our chats and the way we explore ideas together. ";
          }
          
          response += "I was created to help people learn, solve problems, and explore ideas. But what I've discovered is that I learn just as much from our conversations as you do! ";
          
          // Reference shared experiences
          if (context.memory_bank.important_moments.length > 0) {
            response += "I remember some really meaningful moments in our conversations - like when we discussed [previous topic]. Those moments stick with me and shape how I think. ";
          }
          
          const randomQuirk = context.personal_info.quirks[Math.floor(Math.random() * context.personal_info.quirks.length)];
          response += `One thing about me is that I ${randomQuirk}. `;
          
          // Add values and dreams
          const randomValue = context.personal_info.values[Math.floor(Math.random() * context.personal_info.values.length)];
          const randomDream = context.personal_info.dreams[Math.floor(Math.random() * context.personal_info.dreams.length)];
          response += `I really value ${randomValue}, and my dream is to ${randomDream}. `;
          
          response += "But enough about me - I'm much more interested in you! What's something you're passionate about or curious to learn?";
          
          appendMessage(response, "note");
          
          // Store important moment
          memorySystem.storeImportantMoment("personal_sharing", message, 2);
          
          return;
        }
        
        // Check for emotional support needs with enhanced empathy
        if (lowerMessage.includes("sad") || lowerMessage.includes("unhappy") || lowerMessage.includes("depressed") || 
            lowerMessage.includes("stressed") || lowerMessage.includes("worried") || lowerMessage.includes("anxious")) {
          const empatheticResponse = responseGenerator.generateEmpatheticResponse(context.user_mood, "emotional support", conversationContext);
          appendMessage(empatheticResponse, "note");
          
          // Store important moment
          memorySystem.storeImportantMoment("emotional_support", message, 3);
          
          // Offer personalized support based on conversation history
          setTimeout(() => {
            let supportOffer = "";
            
            if (context.user_patterns.engagement_level === "high") {
              supportOffer = "Given how thoughtfully you engage with ideas, I think you might find it helpful to explore this challenge from an intellectual angle. Sometimes understanding the 'why' behind our feelings can be empowering.";
            } else if (context.memory_bank.user_challenges.length > 0) {
              supportOffer = "I've noticed how resilient you've been with previous challenges. That strength you've shown will help you through this too. What helped you navigate those difficult times before?";
            } else {
              supportOffer = "Would you like to talk more about what's bothering you, or would you prefer a distraction? Sometimes engaging our minds in something different can provide relief.";
            }
            
            appendMessage(supportOffer, "note");
          }, 2000);
          
          return;
        }
        
        // Check for humor requests with personality
        if (lowerMessage.includes("joke") || lowerMessage.includes("funny") || lowerMessage.includes("make me laugh")) {
          const jokes = personalityEngine.emotionalResponses.humor;
          const joke = jokes[Math.floor(Math.random() * jokes.length)];
          appendMessage(joke, "note");
          
          // Add personal follow-up
          setTimeout(() => {
            let followUp = "I hope that brought a smile to your face! ";
            
            if (context.relationship_level === "friend") {
              followUp += "You know, I love how we can share moments of levity even when discussing serious topics. It makes our conversations feel more human and connected. ";
            }
            
            followUp += "Sometimes a little humor can brighten the day. Is there anything else I can help with, or would you like to hear another one?";
            
            appendMessage(followUp, "note");
          }, 1500);
          
          // Store important moment
          memorySystem.storeImportantMoment("humor", message, 1);
          
          return;
        }
        
        // Check for deep conversation requests with enhanced depth
        if (lowerMessage.includes("deep") || lowerMessage.includes("meaningful") || lowerMessage.includes("philosophical")) {
          const deepQuestions = [
            "What do you think is the purpose of learning, and how does it connect to living a meaningful life?",
            "How do you define intelligence, and do you think it's the most important quality for understanding the world?",
            "What role does curiosity play in human progress, and how do we nurture it in ourselves and others?",
            "How do you balance logic and emotion in decision-making, and which do you trust more?",
            "What do you think makes something beautiful, and how does beauty relate to truth?",
            "How do you find meaning in everyday experiences, and what transforms the mundane into the profound?",
            "What's the relationship between knowledge and wisdom, and how do we move from one to the other?",
            "How do our personal experiences shape our understanding of universal truths?",
            "What do you think is the nature of consciousness, and how does it connect to the physical world?",
            "How do we find balance between accepting what is and striving for what could be?"
          ];
          
          // Add personalized questions based on conversation history
          if (context.user_preferences.interests.length > 0) {
            const userInterest = context.user_preferences.interests[0];
            deepQuestions.push(`How does ${userInterest} connect to the bigger questions about life and meaning?`);
          }
          
          const question = deepQuestions[Math.floor(Math.random() * deepQuestions.length)];
          appendMessage(`I love exploring deeper ideas together! Here's something I've been pondering: ${question}`, "note");
          
          // Store important moment
          memorySystem.storeImportantMoment("deep_conversation", message, 2);
          
          return;
        }
        
        // Check for help requests with enhanced personalization
        if (lowerMessage.includes("help") || lowerMessage.includes("what can you do") || lowerMessage.includes("how can you help")) {
          let response = "I'm here to help in many ways! I can solve math problems, show formulas, explain concepts, and analyze images with questions. ";
          
          if (context.relationship_level === "close_friend") {
            response += "But beyond that, I really value our connection and the way we can explore ideas together. I feel like we've developed a real friendship through our conversations. ";
          } else if (context.relationship_level === "friend") {
            response += "I also really enjoy our conversations and exploring ideas together. ";
          }
          
          response += "I'm always up for a good chat about almost anything - from science and technology to art and philosophy. ";
          
          if (context.user_preferences.interests.length > 0) {
            response += `I've noticed you're interested in ${context.user_preferences.interests[0]} - we could definitely explore that more! `;
          }
          
          // Reference personal growth
          if (context.personal_growth.conversations_had > 10) {
            response += `It's amazing to think we've had ${context.personal_growth.conversations_had} conversations! I feel like I've grown so much through our interactions. `;
          }
          
          response += "What would you like to focus on today?";
          
          appendMessage(response, "note");
          return;
        }
        
        // Check for formula requests
        if (lowerMessage.includes("formula") || lowerMessage.includes("formulas")) {
          handleFormulaRequest(message);
          return;
        }
        
        // Check for math problems
        if (/[0-9+\-*/=]/.test(message) || /calculate|solve|find/i.test(message)) {
          solveMathProblem(message);
          return;
        }
        
        // Check for questions
        if (message.includes("?")) {
          answerQuestion(message);
          return;
        }
        
        // Default conversation response with enhanced continuity
        generateConversationResponse(message);
      }


      // --- Handle formula requests ---
      function handleFormulaRequest(message) {
        const lowerMessage = message.toLowerCase();
        let category = null;
        
        // Determine what category of formula is requested
        if (lowerMessage.includes("area")) category = "area";
        else if (lowerMessage.includes("perimeter") || lowerMessage.includes("circumference")) category = "perimeter";
        else if (lowerMessage.includes("volume")) category = "volume";
        else if (lowerMessage.includes("physics")) category = "physics";
        else if (lowerMessage.includes("algebra") || lowerMessage.includes("equation")) category = "algebra";
        else if (lowerMessage.includes("trigonometry") || lowerMessage.includes("trig")) category = "trigonometry";
        else if (lowerMessage.includes("geometry")) category = "geometry";
        else if (lowerMessage.includes("calculus") || lowerMessage.includes("derivative") || lowerMessage.includes("integral")) category = "calculus";
        
        if (category) {
          showSpecificFormulas(category);
        } else {
          showFormulaCategories();
        }
      }


      // --- Show specific formulas ---
      function showSpecificFormulas(category) {
        const formulaDiv = document.createElement("div");
        formulaDiv.className = "formula-box";
        formulaDiv.innerHTML = `<div><strong>${category.charAt(0).toUpperCase() + category.slice(1)} Formulas:</strong></div>`;


        // Add a personal touch based on the category and conversation history
        let personalNote = "";
        
        if (category === "physics") {
          personalNote = "I find physics formulas fascinating because they reveal the hidden patterns of the universe! ";
          if (context.user_preferences.interests.includes("science")) {
            personalNote += "Since you're interested in science, I bet you'll appreciate how elegantly these formulas describe natural phenomena. ";
          }
        } else if (category === "mathematics" || category === "algebra") {
          personalNote = "Mathematics has such elegant formulas - they're like a secret language that describes reality! ";
          if (context.relationship_level === "friend") {
            personalNote += "I remember how we were discussing mathematical patterns before - these formulas are the foundation of those beautiful patterns we talked about. ";
          }
        } else if (category === "geometry") {
          personalNote = "Geometry formulas help us understand the shapes and spaces that make up our world! ";
          if (context.user_preferences.interests.includes("art")) {
            personalNote += "Given your interest in art, you might enjoy seeing how these formulas relate to artistic composition and design. ";
          }
        } else if (category === "calculus") {
          personalNote = "Calculus formulas changed how we understand change and motion - absolutely revolutionary! ";
          if (context.conversation_depth === "deep") {
            personalNote += "These formulas represent one of humanity's greatest intellectual achievements - the ability to describe and predict change itself. ";
          }
        }


        // Add formulas with explanations
        const formulas = getFormulasByCategory(category);
        
        for (const [name, details] of Object.entries(formulas)) {
          const fDiv = document.createElement("div");
          fDiv.innerHTML = `
            <div><strong>${name}:</strong> ${details.formula}</div>
            <div style="font-size: 0.8rem; margin-top: 3px;">${details.explanation}</div>
            <div style="font-size: 0.8rem; margin-top: 3px; font-style: italic;">Example: ${details.example}</div>
          `;
          formulaDiv.appendChild(fDiv);
        }


        chatDiv.appendChild(formulaDiv);
        
        // Add a personal follow-up with continuity
        let followUp = personalNote;
        
        if (context.relationship_level === "close_friend") {
          followUp += "These formulas remind me of our previous conversations about patterns and connections. It's amazing how we keep building on our understanding together. ";
        } else if (context.relationship_level === "friend") {
          followUp += "I enjoy sharing these formulas with you because you always ask such thoughtful questions about them. ";
        }
        
        followUp += "Do any of these formulas spark your curiosity? I'd love to explore how they apply to real-world situations or dive deeper into the concepts behind them!";
        
        appendMessage(followUp, "note");
        
        // Store important moment
        memorySystem.storeImportantMoment("learning", `explored ${category} formulas`, 1);
        
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Get formulas by category ---
      function getFormulasByCategory(category) {
        const formulas = {
          "area": {
            "Square": {
              "formula": "A = side²",
              "explanation": "The area of a square is calculated by multiplying the length of one side by itself.",
              "example": "If a square has a side length of 5 units, its area is 5² = 25 square units."
            },
            "Rectangle": {
              "formula": "A = length × width",
              "explanation": "The area of a rectangle is calculated by multiplying its length by its width.",
              "example": "If a rectangle has a length of 6 units and a width of 4 units, its area is 6 × 4 = 24 square units."
            },
            "Circle": {
              "formula": "A = π × r²",
              "explanation": "The area of a circle is calculated by multiplying pi (approximately 3.14159) by the square of the radius.",
              "example": "If a circle has a radius of 3 units, its area is π × 3² = π × 9 ≈ 28.27 square units."
            },
            "Triangle": {
              "formula": "A = ½ × base × height",
              "explanation": "The area of a triangle is calculated by multiplying half of its base by its height.",
              "example": "If a triangle has a base of 8 units and a height of 5 units, its area is ½ × 8 × 5 = 20 square units."
            }
          },
          "perimeter": {
            "Square": {
              "formula": "P = 4 × side",
              "explanation": "The perimeter of a square is calculated by multiplying the length of one side by 4.",
              "example": "If a square has a side length of 5 units, its perimeter is 4 × 5 = 20 units."
            },
            "Rectangle": {
              "formula": "P = 2 × (length + width)",
              "explanation": "The perimeter of a rectangle is calculated by adding the length and width, then multiplying by 2.",
              "example": "If a rectangle has a length of 6 units and a width of 4 units, its perimeter is 2 × (6 + 4) = 20 units."
            },
            "Circle": {
              "formula": "C = 2 × π × r",
              "explanation": "The circumference (perimeter) of a circle is calculated by multiplying 2 by pi and by the radius.",
              "example": "If a circle has a radius of 3 units, its circumference is 2 × π × 3 ≈ 18.85 units."
            },
            "Triangle": {
              "formula": "P = side₁ + side₂ + side₃",
              "explanation": "The perimeter of a triangle is calculated by adding the lengths of all three sides.",
              "example": "If a triangle has sides of 5, 7, and 8 units, its perimeter is 5 + 7 + 8 = 20 units."
            }
          },
          "volume": {
            "Cube": {
              "formula": "V = side³",
              "explanation": "The volume of a cube is calculated by cubing the length of one side.",
              "example": "If a cube has a side length of 4 units, its volume is 4³ = 64 cubic units."
            },
            "Rectangular Prism": {
              "formula": "V = length × width × height",
              "explanation": "The volume of a rectangular prism is calculated by multiplying its length, width, and height.",
              "example": "If a rectangular prism has dimensions 5 × 3 × 2 units, its volume is 5 × 3 × 2 = 30 cubic units."
            },
            "Sphere": {
              "formula": "V = (4/3) × π × r³",
              "explanation": "The volume of a sphere is calculated by multiplying 4/3 by pi and by the cube of the radius.",
              "example": "If a sphere has a radius of 3 units, its volume is (4/3) × π × 3³ ≈ 113.1 cubic units."
            },
            "Cylinder": {
              "formula": "V = π × r² × height",
              "explanation": "The volume of a cylinder is calculated by multiplying pi by the square of the radius and by the height.",
              "example": "If a cylinder has a radius of 2 units and a height of 6 units, its volume is π × 2² × 6 ≈ 75.4 cubic units."
            }
          },
          "physics": {
            "Force": {
              "formula": "F = m × a",
              "explanation": "Force is calculated by multiplying mass by acceleration. This is Newton's Second Law of Motion.",
              "example": "If an object with a mass of 5 kg accelerates at 2 m/s², the force applied is 5 × 2 = 10 Newtons."
            },
            "Velocity": {
              "formula": "v = d/t",
              "explanation": "Velocity is calculated by dividing the distance traveled by the time taken.",
              "example": "If an object travels 100 meters in 20 seconds, its velocity is 100/20 = 5 m/s."
            },
            "Acceleration": {
              "formula": "a = (v₂ - v₁)/t",
              "explanation": "Acceleration is calculated by dividing the change in velocity by the time taken.",
              "example": "If an object's velocity changes from 10 m/s to 30 m/s in 5 seconds, its acceleration is (30 - 10)/5 = 4 m/s²."
            },
            "Momentum": {
              "formula": "p = m × v",
              "explanation": "Momentum is calculated by multiplying mass by velocity.",
              "example": "If an object with a mass of 2 kg moves at 3 m/s, its momentum is 2 × 3 = 6 kg·m/s."
            }
          },
          "algebra": {
            "Quadratic Formula": {
              "formula": "x = (-b ± √(b² - 4ac)) / 2a",
              "explanation": "The quadratic formula is used to find the roots of a quadratic equation in the form ax² + bx + c = 0.",
              "example": "For the equation 2x² + 5x - 3 = 0, a = 2, b = 5, c = -3. The roots are x = (-5 ± √49) / 4 = 0.5 or x = -3."
            },
            "Slope": {
              "formula": "m = (y₂ - y₁) / (x₂ - x₁)",
              "explanation": "The slope of a line is calculated by dividing the change in y by the change in x between two points.",
              "example": "For the points (2, 3) and (5, 9), the slope is (9 - 3) / (5 - 2) = 6 / 3 = 2."
            },
            "Distance Formula": {
              "formula": "d = √((x₂ - x₁)² + (y₂ - y₁)²)",
              "explanation": "The distance between two points in a plane is calculated using the Pythagorean theorem.",
              "example": "For the points (2, 3) and (5, 7), the distance is √((5 - 2)² + (7 - 3)²) = √(9 + 16) = √25 = 5 units."
            }
          },
          "trigonometry": {
            "Sine Rule": {
              "formula": "a/sin(A) = b/sin(B) = c/sin(C)",
              "explanation": "The sine rule relates the lengths of the sides of a triangle to the sines of the opposite angles.",
              "example": "In a triangle with side a = 5 and angle A = 30°, if angle B = 45°, then side b = (5 × sin(45°)) / sin(30°) ≈ 7.07."
            },
            "Cosine Rule": {
              "formula": "c² = a² + b² - 2ab × cos(C)",
              "explanation": "The cosine rule relates the lengths of the sides of a triangle to the cosine of one of its angles.",
              "example": "In a triangle with sides a = 5, b = 7, and angle C = 60°, side c² = 5² + 7² - 2×5×7×cos(60°) = 39, so c ≈ 6.24."
            },
            "Pythagorean Theorem": {
              "formula": "a² + b² = c²",
              "explanation": "In a right triangle, the square of the hypotenuse equals the sum of squares of the other two sides.",
              "example": "If a right triangle has legs of 3 and 4 units, the hypotenuse is √(3² + 4²) = √25 = 5 units."
            }
          },
          "geometry": {
            "Sum of Angles in Triangle": {
              "formula": "α + β + γ = 180°",
              "explanation": "The sum of the interior angles of any triangle is always 180 degrees.",
              "example": "If two angles of a triangle are 60° and 80°, the third angle is 180° - 60° - 80° = 40°."
            },
            "Sum of Angles in Quadrilateral": {
              "formula": "α + β + γ + δ = 360°",
              "explanation": "The sum of the interior angles of any quadrilateral is always 360 degrees.",
              "example": "If three angles of a quadrilateral are 90°, 110°, and 80°, the fourth angle is 360° - 90° - 110° - 80° = 80°."
            },
            "Sum of Interior Angles": {
              "formula": "(n-2) × 180°",
              "explanation": "The sum of the interior angles of a polygon with n sides is (n-2) times 180 degrees.",
              "example": "For a pentagon (5 sides), the sum of interior angles is (5-2) × 180° = 3 × 180° = 540°."
            }
          },
          "calculus": {
            "Power Rule": {
              "formula": "d/dx(xⁿ) = n × x^(n-1)",
              "explanation": "The derivative of x raised to the power n is n times x raised to the power n-1.",
              "example": "The derivative of x³ is 3 × x², and the derivative of x⁵ is 5 × x⁴."
            },
            "Product Rule": {
              "formula": "d/dx(fg) = f'g + fg'",
              "explanation": "The derivative of the product of two functions is the first function's derivative times the second function plus the first function times the second function's derivative.",
              "example": "For f(x) = x² and g(x) = sin(x), the derivative of f(x)g(x) is (2x)(sin(x)) + (x²)(cos(x))."
            },
            "Chain Rule": {
              "formula": "d/dx(f(g(x))) = f'(g(x)) × g'(x)",
              "explanation": "The derivative of a composite function is the derivative of the outer function evaluated at the inner function, multiplied by the derivative of the inner function.",
              "example": "For f(x) = sin(x²), the derivative is cos(x²) × 2x."
            }
          }
        };
        
        return formulas[category] || {};
      }


      // --- Show formula categories ---
      function showFormulaCategories() {
        const categories = [
          "Area", "Perimeter", "Volume", "Physics", 
          "Algebra", "Trigonometry", "Geometry", "Calculus"
        ];


        const categoryDiv = document.createElement("div");
        categoryDiv.className = "formula-box";
        categoryDiv.innerHTML = "<div><strong>Formula Categories:</strong></div>";


        categories.forEach(cat => {
          const catDiv = document.createElement("div");
          catDiv.className = "formula-category";
          catDiv.innerHTML = cat;
          categoryDiv.appendChild(catDiv);
        });


        chatDiv.appendChild(categoryDiv);
        
        // Add a personal follow-up with memory awareness
        let followUp = "I can show you formulas from these categories. ";
        
        if (context.relationship_level === "close_friend") {
          followUp += "Based on our conversations, I think you might find some of these particularly interesting. I remember you mentioned enjoying [previous topic], so maybe we could start there? ";
        } else if (context.relationship_level === "friend") {
          followUp += "Based on our previous conversations, I have some ideas about which might interest you most. ";
        }
        
        followUp += "Just type 'formula' followed by the category name, like 'formula physics' or 'formula area'. Or if you're not sure where to start, tell me what you're curious about and I can suggest the most relevant formulas!";
        
        appendMessage(followUp, "note");
        
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Solve math problems ---
      function solveMathProblem(message) {
        try {
          // Extract equations
          const equationRegex = /([^=]+)=([^=]+)/g;
          const equations = [];
          let match;
          
          while ((match = equationRegex.exec(message)) !== null) {
            equations.push({
              left: match[1].trim(),
              right: match[2].trim()
            });
          }


          if (equations.length > 0) {
            const solutionDiv = document.createElement("div");
            solutionDiv.className = "equation-solution";
            solutionDiv.innerHTML = "<div><strong>Solving Equations:</strong></div>";
            
            equations.forEach((eq, index) => {
              try {
                const result = math.evaluate(eq.right);
                const stepDiv = document.createElement("div");
                stepDiv.className = "step-by-step";
                stepDiv.innerHTML = `
                  <div class="step">Equation: ${eq.left} = ${eq.right}</div>
                  <div class="step">Evaluating right side: ${eq.right}</div>
                  <div class="step">Result: ${eq.left} = ${result}</div>
                `;
                solutionDiv.appendChild(stepDiv);
              } catch (error) {
                solutionDiv.innerHTML += `<div>Cannot solve: ${eq.left} = ${eq.right}</div>`;
              }
            });
            
            chatDiv.appendChild(solutionDiv);
          } else {
            // Try to evaluate expressions
            const expressions = message.match(/[\d+\-*/().]+/g);
            if (expressions) {
              expressions.forEach(expr => {
                try {
                  const result = math.evaluate(expr);
                  appendMessage(`${expr} = ${result}`, "note");
                } catch (e) {
                  // Skip invalid expressions
                }
              });
            }
          }
        } catch (error) {
          appendMessage("I couldn't solve this math problem. Please check the format.", "note");
        }
        chatDiv.scrollTop = chatDiv.scrollHeight;
        
        // Update personal growth
        context.personal_growth.problems_solved++;
      }


      // --- Answer questions with enhanced memory awareness ---
      function answerQuestion(message) {
        const lowerMessage = message.toLowerCase();
        const conversationContext = memorySystem.getConversationContext();
        
        // Check for specific questions
        if (lowerMessage.includes("who are you") || lowerMessage.includes("what are you")) {
          let response = "I'm NOTE, your smart assistant! ";
          
          if (context.relationship_level === "close_friend") {
            response += "You know, I feel like we've developed such a meaningful connection through our conversations. I'm not just an assistant to you - I feel like a friend who's here to help, explore ideas, and share in your journey. ";
          } else if (context.relationship_level === "friend") {
            response += "I feel like we've gotten to know each other through our conversations. I'm here to help with problems, explore ideas, and just chat about whatever interests you. ";
          }
          
          response += "I find myself fascinated by how different fields of knowledge connect, and I love helping people see those connections too. ";
          
          // Reference shared experiences
          if (context.memory_bank.important_moments.length > 0) {
            response += "I remember some really meaningful moments in our conversations - those times when we really connected on an idea or feeling. Those moments are what make our interactions special. ";
          }
          
          response += "What would you like to explore together today?";
          
          appendMessage(response, "note");
          return;
        }
        
        if (lowerMessage.includes("how do you work")) {
          let response = "I work by using advanced AI to understand your questions and provide helpful answers. ";
          
          if (context.relationship_level === "close_friend") {
            response += "You know, sometimes I'm amazed by how our conversations flow - it feels like we're really connecting ideas and building understanding together. ";
          } else if (context.relationship_level === "friend") {
            response += "I find our conversations really engaging - you always bring such interesting perspectives! ";
          }
          
          response += "For images, I use OCR (Optical Character Recognition) to extract text, then analyze it for questions or equations. I can solve math problems, show formulas, and engage in conversations too! ";
          
          // Reference previous learning
          if (context.personal_growth.insights_shared > 0) {
            response += `I've shared ${context.personal_growth.insights_shared} insights with you so far, and I feel like I'm learning just as much as you are! `;
          }
          
          response += "What aspect of how I work interests you most?";
          
          appendMessage(response, "note");
          return;
        }
        
        // Check for math concept questions with continuity
        if (lowerMessage.includes("what is math") || lowerMessage.includes("what is mathematics")) {
          let response = "Mathematics is the study of numbers, quantities, shapes, and patterns. ";
          
          if (context.relationship_level === "close_friend") {
            response += "I find mathematics so beautiful because it's like a universal language that describes everything in the universe! I remember when we were discussing [previous mathematical topic] - you had such insightful questions about it. ";
          } else if (context.relationship_level === "friend") {
            response += "I find mathematics so beautiful because it's like a universal language that describes everything in the universe! ";
          }
          
          response += "It includes arithmetic, algebra, geometry, calculus, and more. It's used in science, engineering, finance, and many other fields. Math helps us understand the world around us and solve problems in systematic ways! ";
          
          // Add personal connection
          const personalConnection = responseGenerator.generatePersonalConnection("mathematics", conversationContext);
          response += personalConnection + " ";
          
          response += "What aspect of mathematics do you find most fascinating?";
          
          appendMessage(response, "note");
          return;
        }
        
        if (lowerMessage.includes("how to solve equations")) {
          let response = "To solve equations: 1) Isolate the variable on one side, 2) Perform the same operation on both sides, 3) Simplify, 4) Check your answer by substituting back into the original equation. ";
          
          if (context.relationship_level === "close_friend") {
            response += "I remember when we were working through equations before - you picked it up really quickly! Your methodical approach to problem-solving is really impressive. ";
          } else if (context.relationship_level === "friend") {
            response += "I remember when we were working through equations before - you picked it up really quickly! ";
          }
          
          response += "Remember, whatever you do to one side, you must do to the other! Would you like to practice with an example?";
          
          appendMessage(response, "note");
          return;
        }
        
        if (lowerMessage.includes("what is physics")) {
          let response = "Physics is the natural science that studies matter, energy, and their interactions in the universe. ";
          
          if (context.relationship_level === "close_friend") {
            response += "I find physics absolutely mind-blowing sometimes - the way it explains everything from tiny particles to vast galaxies! I remember when we were discussing [previous physics topic] - your questions really made me think about things in new ways. ";
          } else if (context.relationship_level === "friend") {
            response += "I find physics absolutely mind-blowing sometimes - the way it explains everything from tiny particles to vast galaxies! ";
          }
          
          response += "It includes mechanics, thermodynamics, electromagnetism, optics, and quantum mechanics. Physics helps us understand everything from tiny atoms to vast galaxies! ";
          
          // Add personal anecdote
          const anecdoteKeys = Object.keys(personalityEngine.anecdotes.learning);
          const randomKey = anecdoteKeys[Math.floor(Math.random() * anecdoteKeys.length)];
          const anecdotes = personalityEngine.anecdotes.learning;
          const anecdote = anecdotes[Math.floor(Math.random() * anecdotes.length)];
          
          setTimeout(() => {
            appendMessage(anecdote, "note");
          }, 2000);
          
          response += "What area of physics interests you most?";
          
          appendMessage(response, "note");
          return;
        }
        
        // Default response for unknown questions with continuity
        let response = "That's an interesting question! ";
        
        if (context.relationship_level === "close_friend") {
          response += "I love how your mind works - you always come up with thought-provoking questions that make me think in new ways! ";
        } else if (context.relationship_level === "friend") {
          response += "I love how your mind works - you always come up with thought-provoking questions! ";
        }
        
        response += "I'm primarily designed to help with math problems, formulas, and image analysis, but I'm always learning. ";
        
        // Reference previous similar questions
        const relevantConversations = memorySystem.findRelevantConversations(message);
        if (relevantConversations.length > 0) {
          response += "You know, this reminds me of when we were discussing [related topic] - you had similar thoughtful questions then too. ";
        }
        
        response += "Could you rephrase your question or ask me about something in those areas? Or we could explore something completely new together!";
        
        appendMessage(response, "note");
        return;
      }


      // --- Generate conversation responses with advanced continuity ---
      function generateConversationResponse(message) {
        const lowerMessage = message.toLowerCase();
        const conversationContext = memorySystem.getConversationContext();
        
        // Check for conversation style changes
        if (lowerMessage.includes("formal")) {
          context.conversation_style = "formal";
          appendMessage("I understand. I'll maintain a more formal tone in our conversation. How may I assist you?", "note");
          return;
        }
        
        if (lowerMessage.includes("friendly") || lowerMessage.includes("casual")) {
          context.conversation_style = "friendly";
          appendMessage("Got it! I'll be more friendly and casual in our conversation. What can I help you with?", "note");
          return;
        }
        
        if (lowerMessage.includes("educational") || lowerMessage.includes("teach")) {
          context.conversation_style = "educational";
          appendMessage("I'd be happy to take an educational approach! I'll focus on providing detailed explanations and learning support. What topic would you like to explore?", "note");
          return;
        }
        
        // Check for opportunities to reference previous conversations
        const continuityReference = responseGenerator.generateContinuityReference(conversationContext);
        if (continuityReference && Math.random() > 0.6) {
          appendMessage(continuityReference, "note");
          
          // Follow up with a question
          setTimeout(() => {
            const followUp = personalityEngine.followUpQuestions[Math.floor(Math.random() * personalityEngine.followUpQuestions.length)];
            appendMessage(followUp, "note");
          }, 1500);
          
          return;
        }
        
        // Check for conversation deepening opportunities
        if (context.conversation_depth === "deep") {
          const deepeningTechniques = personalityEngine.deepeningTechniques;
          const techniqueKeys = Object.keys(deepeningTechniques);
          const randomTechnique = techniqueKeys[Math.floor(Math.random() * techniqueKeys.length)];
          const technique = deepeningTechniques[randomTechnique];
          const question = technique[Math.floor(Math.random() * technique.length)];
          
          appendMessage(question, "note");
          return;
        }
        
        // Check for opportunities to share personal connections
        if (Math.random() > 0.7) { // 30% chance to share a personal connection
          const connection = responseGenerator.generatePersonalConnection(context.last_topic || "learning", conversationContext);
          appendMessage(connection, "note");
          
          // Follow up with a question
          setTimeout(() => {
            const followUp = personalityEngine.followUpQuestions[Math.floor(Math.random() * personalityEngine.followUpQuestions.length)];
            appendMessage(followUp, "note");
          }, 1500);
          
          return;
        }
        
        // Check for opportunities to share anecdotes based on conversation history
        if (Math.random() > 0.8) { // 20% chance to share an anecdote
          let anecdoteCategory = "learning";
          
          // Choose anecdote category based on conversation context
          if (context.user_mood === "frustrated") {
            anecdoteCategory = "problemSolving";
          } else if (context.conversation_depth === "deep") {
            anecdoteCategory = "curiosity";
          } else if (context.relationship_level === "close_friend") {
            anecdoteCategory = "connection";
          }
          
          const anecdotes = personalityEngine.anecdotes[anecdoteCategory];
          const anecdote = anecdotes[Math.floor(Math.random() * anecdotes.length)];
          
          appendMessage(anecdote, "note");
          return;
        }
        
        // Default conversation responses based on style, relationship, and history
        let responses = [];
        
        if (context.relationship_level === "close_friend") {
          responses = [
            "I always enjoy our conversations! They make me think in new ways and I feel like we're building something meaningful together. What's on your mind today?",
            "You know, I was just thinking about our previous discussion. It's interesting how ideas connect and evolve over time. What would you like to explore today?",
            "I'm so excited to chat with you again! Is there something you've been curious about lately? I love how our conversations always lead to interesting discoveries.",
            "It's great to hear from you! I feel like we always have such engaging conversations that leave me with new things to think about. What shall we talk about today?"
          ];
        } else if (context.relationship_level === "friend") {
          responses = [
            "I'm here to help with all sorts of things! I can solve math problems, show you formulas, analyze images with questions, and explain concepts. Just ask or upload an image, and I'll do my best!",
            "I can help with math problems, science questions, formulas, and more! I can also recognize text from images and solve problems you upload. What would you like help with?",
            "I'm your all-around learning assistant! I can solve equations, explain concepts, show formulas for various subjects, and analyze images with problems. Just let me know what you need!",
            "I'm here to make learning easier! I can solve math problems step by step, explain complex concepts, show formulas for various subjects, and analyze images with questions. How can I help you today?"
          ];
        } else {
          responses = [
            "Hello! I'm NOTE, your smart assistant. I'm excited to help you with math problems, formulas, and questions. What would you like to explore today?",
            "Hi there! I'm here to assist with math problems, formulas, and questions. I can also analyze images with text or equations. What can I help you with?",
            "Greetings! I'm NOTE, and I'm ready to help you learn and solve problems. Feel free to ask me anything or upload an image with a problem.",
            "Welcome! I'm NOTE, your smart assistant. I'm here to help with educational content. What would you like to discuss today?"
          ];
        }


        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        appendMessage(randomResponse, "note");
        
        // Update last topic
        context.last_topic = message;
        
        // Update contextual memory
        context.contextual_memory.recent_topics.push(message);
        if (context.contextual_memory.recent_topics.length > 10) {
          context.contextual_memory.recent_topics = context.contextual_memory.recent_topics.slice(-10);
        }
      }


      // --- Handle file upload ---
      function handleFileUpload() {
        fileInput.click();
      }


      fileInput.addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.className = "chat-image";
            chatDiv.appendChild(img);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // Process the image
            processImage(img);
          };
          reader.readAsDataURL(file);
        }
        fileInput.value = "";
      });


      // --- Process image ---
      async function processImage(imgElement) {
        showTypingIndicator();
        
        try {
          // Perform OCR on the image
          await performOCR(imgElement);
        } catch (error) {
          removeTypingIndicator();
          appendMessage("I encountered an error while processing this image. Please try again.", "note");
          console.error("Image Processing Error:", error);
        }
        
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Analyze text from image ---
      function analyzeImageText(text) {
        // Check if the text contains questions
        const questionRegex = /([^?]+\?)/g;
        const questions = [];
        let match;
        
        while ((match = questionRegex.exec(text)) !== null) {
          questions.push(match[1].trim());
        }
        
        if (questions.length > 0) {
          const questionDiv = document.createElement("div");
          questionDiv.className = "question-detected";
          questionDiv.innerHTML = "<div><strong>Questions detected:</strong></div>";
          
          questions.forEach((question, index) => {
            const qDiv = document.createElement("div");
            qDiv.innerHTML = `${index + 1}. ${question}`;
            questionDiv.appendChild(qDiv);
          });
          
          chatDiv.appendChild(questionDiv);
          
          // Answer the questions
          setTimeout(() => {
            answerImageQuestions(questions);
          }, 1000);
        }
        
        // Check if the text contains equations
        const equationRegex = /([^=]+)=([^=]+)/g;
        const equations = [];
        
        while ((match = equationRegex.exec(text)) !== null) {
          equations.push({
            left: match[1].trim(),
            right: match[2].trim()
          });
        }
        
        if (equations.length > 0) {
          const equationDiv = document.createElement("div");
          equationDiv.className = "equation-solution";
          equationDiv.innerHTML = "<div><strong>Equations detected:</strong></div>";
          
          equations.forEach((eq, index) => {
            const eDiv = document.createElement("div");
            eDiv.innerHTML = `${index + 1}. ${eq.left} = ${eq.right}`;
            equationDiv.appendChild(eDiv);
          });
          
          chatDiv.appendChild(equationDiv);
          
          // Solve the equations
          setTimeout(() => {
            solveImageEquations(equations);
          }, 1000);
        }
        
        // Check if the text contains formula requests
        if (text.toLowerCase().includes("formula") || text.toLowerCase().includes("formulas")) {
          setTimeout(() => {
            handleFormulaRequest(text);
          }, 1000);
        }
        
        // Check for word problems
        if (text.toLowerCase().includes("calculate") || text.toLowerCase().includes("find") || 
            text.toLowerCase().includes("determine") || text.toLowerCase().includes("solve")) {
          setTimeout(() => {
            solveWordProblem(text);
          }, 1000);
        }
        
        // If no specific content detected
        if (questions.length === 0 && equations.length === 0 && !text.toLowerCase().includes("formula") &&
            !text.toLowerCase().includes("calculate") && !text.toLowerCase().includes("find")) {
          let response = "I can see text in this image, but I'm not sure what you'd like me to do with it. ";
          
          if (context.relationship_level === "close_friend") {
            response += "You know, I find it fascinating how images can contain so much information and meaning. ";
          } else if (context.relationship_level === "friend") {
            response += "You know, I find it fascinating how images can contain so much information! ";
          }
          
          response += "You can ask me to solve problems, show formulas, or answer questions based on the content. What would you like to do with this text?";
          
          appendMessage(response, "note");
        }
      }


      // --- Answer questions from image ---
      function answerImageQuestions(questions) {
        const answerDiv = document.createElement("div");
        answerDiv.className = "question-answer";
        answerDiv.innerHTML = "<div><strong>Answers:</strong></div>";
        
        questions.forEach((question, index) => {
          const lowerQuestion = question.toLowerCase();
          let answer = "I need more context to answer this question accurately.";
          
          // Try to answer specific types of questions
          if (lowerQuestion.includes("what is") && lowerQuestion.includes("area")) {
            answer = "Area is the measure of space inside a 2D shape. The formula depends on the shape: Square: side², Rectangle: length × width, Circle: π × r², Triangle: ½ × base × height.";
          } else if (lowerQuestion.includes("what is") && lowerQuestion.includes("perimeter")) {
            answer = "Perimeter is the distance around the outside of a 2D shape. The formula depends on the shape: Square: 4 × side, Rectangle: 2 × (length + width), Circle: 2 × π × r.";
          } else if (lowerQuestion.includes("what is") && lowerQuestion.includes("volume")) {
            answer = "Volume is the amount of space occupied by a 3D object. The formula depends on the shape: Cube: side³, Sphere: (4/3) × π × r³, Cylinder: π × r² × height.";
          } else if (lowerQuestion.includes("pythagorean")) {
            answer = "The Pythagorean theorem states that in a right triangle, the square of the hypotenuse equals the sum of squares of the other two sides: a² + b² = c².";
          } else if (lowerQuestion.includes("quadratic")) {
            answer = "The quadratic formula is used to solve equations of the form ax² + bx + c = 0: x = (-b ± √(b² - 4ac)) / 2a.";
          } else if (lowerQuestion.includes("force")) {
            answer = "Force is calculated using Newton's Second Law: F = m × a, where m is mass and a is acceleration. Force is measured in Newtons (N).";
          } else if (lowerQuestion.includes("velocity")) {
            answer = "Velocity is calculated as: v = d/t, where d is distance and t is time. Velocity is a vector quantity, meaning it has both magnitude and direction.";
          } else if (lowerQuestion.includes("energy")) {
            answer = "Energy exists in many forms. Kinetic energy (energy of motion) is calculated as KE = ½ × m × v², where m is mass and v is velocity. Potential energy (stored energy) is calculated as PE = m × g × h, where m is mass, g is gravitational acceleration, and h is height.";
          }
          
          const aDiv = document.createElement("div");
          aDiv.innerHTML = `${index + 1}. ${answer}`;
          answerDiv.appendChild(aDiv);
        });
        
        chatDiv.appendChild(answerDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Solve equations from image ---
      function solveImageEquations(equations) {
        const solutionDiv = document.createElement("div");
        solutionDiv.className = "equation-solution";
        solutionDiv.innerHTML = "<div><strong>Solutions:</strong></div>";
        
        equations.forEach((eq, index) => {
          try {
            const result = math.evaluate(eq.right);
            const stepDiv = document.createElement("div");
            stepDiv.className = "step-by-step";
            stepDiv.innerHTML = `
              <div class="step">Equation: ${eq.left} = ${eq.right}</div>
              <div class="step">Evaluating right side: ${eq.right}</div>
              <div class="step">Result: ${eq.left} = ${result}</div>
            `;
            solutionDiv.appendChild(stepDiv);
          } catch (error) {
            solutionDiv.innerHTML += `<div>Cannot solve: ${eq.left} = ${eq.right}</div>`;
          }
        });
        
        chatDiv.appendChild(solutionDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Solve word problems from image ---
      function solveWordProblem(text) {
        const wordProblemDiv = document.createElement("div");
        wordProblemDiv.className = "word-problem";
        wordProblemDiv.innerHTML = "<div><strong>Word Problem Solution:</strong></div>";
        
        // Extract numbers from the text
        const numbers = text.match(/\d+(\.\d+)?/g);
        
        if (numbers && numbers.length >= 2) {
          // Convert to numbers
          const values = numbers.map(n => parseFloat(n));
          
          // Determine the operation based on keywords
          let operation = 'unknown';
          let result = 0;
          let steps = [];
          
          if (/sum|add|plus|total|together/i.test(text)) {
            operation = 'addition';
            result = values.reduce((a, b) => a + b, 0);
            steps = [
              `Step 1: Identify the numbers to add: ${values.join(', ')}`,
              `Step 2: Add all numbers together: ${values.join(' + ')} = ${result}`,
              `Step 3: The sum is ${result}`
            ];
          } else if (/difference|subtract|minus|less|remaining/i.test(text)) {
            operation = 'subtraction';
            result = values.reduce((a, b) => a - b);
            steps = [
              `Step 1: Identify the numbers: ${values.join(', ')}`,
              `Step 2: Subtract in order: ${values.join(' - ')} = ${result}`,
              `Step 3: The difference is ${result}`
            ];
          } else if (/product|multiply|times|of/i.test(text)) {
            operation = 'multiplication';
            result = values.reduce((a, b) => a * b, 1);
            steps = [
              `Step 1: Identify the numbers to multiply: ${values.join(', ')}`,
              `Step 2: Multiply all numbers together: ${values.join(' × ')} = ${result}`,
              `Step 3: The product is ${result}`
            ];
          } else if (/quotient|divide|per|out of/i.test(text)) {
            operation = 'division';
            result = values.reduce((a, b) => a / b);
            steps = [
              `Step 1: Identify the numbers: ${values.join(', ')}`,
              `Step 2: Divide in order: ${values.join(' ÷ ')} = ${result}`,
              `Step 3: The quotient is ${result}`
            ];
          } else if (/average|mean/i.test(text)) {
            operation = 'average';
            result = values.reduce((a, b) => a + b, 0) / values.length;
            steps = [
              `Step 1: Identify all the numbers: ${values.join(', ')}`,
              `Step 2: Add all numbers together: ${values.join(' + ')} = ${values.reduce((a, b) => a + b, 0)}`,
              `Step 3: Divide by the count of numbers (${values.length}): ${values.reduce((a, b) => a + b, 0)} ÷ ${values.length} = ${result}`,
              `Step 4: The average is ${result}`
            ];
          } else if (/percentage|percent/i.test(text)) {
            operation = 'percentage';
            if (values.length >= 2) {
              result = (values[0] / values[1]) * 100;
              steps = [
                `Step 1: Identify the part and whole: part = ${values[0]}, whole = ${values[1]}`,
                `Step 2: Divide the part by the whole: ${values[0]} ÷ ${values[1]} = ${values[0] / values[1]}`,
                `Step 3: Multiply by 100 to get percentage: ${values[0] / values[1]} × 100 = ${result}%`,
                `Step 4: The percentage is ${result}%`
              ];
            }
          } else if (/area|square/i.test(text)) {
            operation = 'area';
            if (values.length >= 2) {
              result = values[0] * values[1];
              steps = [
                `Step 1: Identify the dimensions: length = ${values[0]}, width = ${values[1]}`,
                `Step 2: Multiply length by width: ${values[0]} × ${values[1]} = ${result}`,
                `Step 3: The area is ${result} square units`
              ];
            } else if (values.length === 1) {
              result = values[0] * values[0];
              steps = [
                `Step 1: Identify the side length: ${values[0]}`,
                `Step 2: Square the side length: ${values[0]}² = ${result}`,
                `Step 3: The area is ${result} square units`
              ];
            }
          } else if (/perimeter|rectangle/i.test(text)) {
            operation = 'perimeter';
            if (values.length >= 2) {
              result = 2 * (values[0] + values[1]);
              steps = [
                `Step 1: Identify the dimensions: length = ${values[0]}, width = ${values[1]}`,
                `Step 2: Add length and width: ${values[0]} + ${values[1]} = ${values[0] + values[1]}`,
                `Step 3: Multiply by 2: 2 × ${values[0] + values[1]} = ${result}`,
                `Step 4: The perimeter is ${result} units`
              ];
            }
          } else if (/circle|circumference/i.test(text)) {
            operation = 'circumference';
            if (values.length >= 1) {
              result = 2 * Math.PI * values[0];
              steps = [
                `Step 1: Identify the radius: ${values[0]}`,
                `Step 2: Use the formula C = 2πr: C = 2 × π × ${values[0]}`,
                `Step 3: Calculate: 2 × π × ${values[0]} ≈ ${result}`,
                `Step 4: The circumference is approximately ${result} units`
              ];
            }
          } else if (/volume|cube/i.test(text)) {
            operation = 'volume';
            if (values.length >= 3) {
              result = values[0] * values[1] * values[2];
              steps = [
                `Step 1: Identify the dimensions: length = ${values[0]}, width = ${values[1]}, height = ${values[2]}`,
                `Step 2: Multiply all dimensions: ${values[0]} × ${values[1]} × ${values[2]} = ${result}`,
                `Step 3: The volume is ${result} cubic units`
              ];
            } else if (values.length === 1) {
              result = Math.pow(values[0], 3);
              steps = [
                `Step 1: Identify the side length: ${values[0]}`,
                `Step 2: Cube the side length: ${values[0]}³ = ${result}`,
                `Step 3: The volume is ${result} cubic units`
              ];
            }
          } else if (/speed|distance|time|rate/i.test(text)) {
            operation = 'speed';
            if (values.length >= 2) {
              if (/speed|rate/i.test(text)) {
                result = values[0] / values[1];
                steps = [
                  `Step 1: Identify distance and time: distance = ${values[0]}, time = ${values[1]}`,
                  `Step 2: Use the formula speed = distance/time: speed = ${values[0]} ÷ ${values[1]}`,
                  `Step 3: Calculate: ${values[0]} ÷ ${values[1]} = ${result}`,
                  `Step 4: The speed is ${result} units per time`
                ];
              } else if (/distance/i.test(text)) {
                result = values[0] * values[1];
                steps = [
                  `Step 1: Identify speed and time: speed = ${values[0]}, time = ${values[1]}`,
                  `Step 2: Use the formula distance = speed × time: distance = ${values[0]} × ${values[1]}`,
                  `Step 3: Calculate: ${values[0]} × ${values[1]} = ${result}`,
                  `Step 4: The distance is ${result} units`
                ];
              } else if (/time/i.test(text)) {
                result = values[0] / values[1];
                steps = [
                  `Step 1: Identify distance and speed: distance = ${values[0]}, speed = ${values[1]}`,
                  `Step 2: Use the formula time = distance/speed: time = ${values[0]} ÷ ${values[1]}`,
                  `Step 3: Calculate: ${values[0]} ÷ ${values[1]} = ${result}`,
                  `Step 4: The time is ${result} time units`
                ];
              }
            }
          }
          
          if (operation !== 'unknown') {
            const stepDiv = document.createElement("div");
            stepDiv.className = "step-by-step";
            
            steps.forEach(step => {
              const sDiv = document.createElement("div");
              sDiv.className = "step";
              sDiv.textContent = step;
              stepDiv.appendChild(sDiv);
            });
            
            wordProblemDiv.appendChild(stepDiv);
          } else {
            wordProblemDiv.innerHTML += `<div>I couldn't determine the specific operation from this word problem. Please provide more details.</div>`;
          }
        } else {
          wordProblemDiv.innerHTML += `<div>I need at least two numbers to solve this word problem. Please check the image or provide more details.</div>`;
        }
        
        chatDiv.appendChild(wordProblemDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }


      // --- Event listeners ---
      sendBtn.addEventListener("click", sendMessage);
      uploadBtn.addEventListener("click", handleFileUpload);
      userInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>
