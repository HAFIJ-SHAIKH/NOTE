
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOTE - Cosmic Midnight</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>

  <!-- Simple Moon and Stars Background -->
  <div class="cosmos">
    <div class="moon"></div>
    <div class="stars"></div>
  </div>

  <div class="app-container">
    <!-- Main Chat Area -->
    <main class="main-content">
      <header class="main-header">
        <!-- Title on the Left -->
        <h1 class="conversation-title" id="noteTitle">
          NOTE
          <span class="title-credit">by hafij shaikh</span>
        </h1>

        <!-- Header Controls Grouped on the Right -->
        <div class="header-controls">
          <button class="header-action-btn scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to Bottom">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <button class="header-action-btn mode-toggle-btn" id="modeToggleBtn" title="Toggle Mode">
            <i class="fas fa-book" id="modeIcon"></i>
          </button>
        </div>
      </header>

      <div class="chat-container" id="chat-container">
        <div id="chat">
          <!-- No initial messages -->
        </div>
      </div>
    </main>
  </div>

  <!-- Fixed Input Area -->
  <footer class="chat-input-container" id="inputContainer">
    <button class="attachment-btn" id="uploadBtn"><i class="fa-solid fa-paperclip"></i></button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <input type="text" id="userInput" placeholder="Type a message...">
    <button class="send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></button>
  </footer>

  <!-- Page Watermark -->
  <div class="page-watermark">note.infinity-Ⅰ</div>

  <!-- Secret Game Screen -->
  <div class="game-screen" id="gameScreen">
    <div class="game-container">
      <div class="game-header">
        <div class="game-score">SCORE: <span id="score">0</span></div>
        <div class="game-lives">LIVES: <span id="lives">3</span></div>
      </div>
      <div class="game-canvas-container">
        <canvas id="gameCanvas"></canvas>
      </div>
      <div class="game-controls">
        <button class="game-btn" id="leftBtn"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="game-btn" id="fireBtn"><i class="fa-solid fa-crosshairs"></i></button>
        <button class="game-btn" id="rightBtn"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
      <div class="game-instructions">
        <p>Desktop: Arrow Keys to move, Space to fire</p>
        <p>Mobile: Use on-screen controls</p>
      </div>
    </div>
  </div>

  <!-- Secret Loading Animation -->
  <div class="secret-loader" id="secretLoader">
    <svg class="infinity-loader" viewBox="0 0 100 40">
      <path d="M20,20 Q30,5 40,20 T60,20 T80,20" />
    </svg>
  </div>

  <style>
    /* --- Cosmic Midnight Color Palette --- */
    :root {
      --bg-gradient-start: #0a0e1a;
      --bg-gradient-end: #050510;
      --glass-bg: rgba(20, 25, 40, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #b8c5d6;
      --text-secondary: #a0b0c5;
      --text-muted: #7a8ca0;
      --accent: #e0e6f1;
      --accent-hover: #f0f4f8;
      --shadow-color: rgba(0, 0, 0, 0.4);
      --glow-color: rgba(224, 230, 241, 0.3);
    }

    html, body { margin: 0; padding: 0; height: 100%; min-height: 100%; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-gradient-start); color: var(--text-primary); overflow: hidden; position: relative;
    }

    /* --- Simple Moon and Stars Background --- */
    .cosmos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .moon {
      position: absolute; top: 15%; right: 20%; width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(224, 230, 241, 0.2) 0%, rgba(224, 230, 241, 0.05) 60%, transparent 100%);
      border-radius: 50%; filter: blur(2px); box-shadow: 0 0 50px var(--glow-color);
    }
    .stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: radial-gradient(1px 1px at 50px 100px, #fff, transparent), radial-gradient(1px 1px at 150px 250px, #fff, transparent);
      background-repeat: repeat; background-size: 600px 400px; opacity: 0.5; animation: twinkle 10s infinite ease-in-out;
    }
    @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

    .app-container { display: flex; flex-direction: column; height: 100vh; position: relative; z-index: 1; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px; 
      flex-shrink: 0; 
      background: transparent; 
    }
    .conversation-title { font-size: 1.5rem; font-weight: 600; display: flex; align-items: baseline; gap: 8px; color: var(--accent); text-shadow: 0 0 10px var(--glow-color); cursor: pointer; user-select: none; }
    .title-credit { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; text-shadow: none; }

    .chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; background: transparent; scrollbar-width: none; -ms-overflow-style: none; }
    .chat-container::-webkit-scrollbar { display: none; }
    #chat { display: flex; flex-direction: column; gap: 15px; }

    /* --- Messages --- */
    .message { 
      display: flex; 
      flex-direction: column; 
      max-width: 70%; 
      transition: transform 0.2s ease-out;
      position: relative;
    }
    .message.note { align-self: flex-start; }
    .message.user { align-self: flex-end; }
    .message-bubble {
      padding: 12px 18px; border-radius: 20px; line-height: 1.5; word-wrap: break-word;
      box-shadow: 0 4px 15px var(--shadow-color);
    }
    .message.note .message-bubble {
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); color: var(--text-primary); border-bottom-left-radius: 6px;
    }
    .message.user .message-bubble {
      background: var(--accent); color: var(--bg-gradient-start); font-weight: 500;
      border-bottom-right-radius: 6px; box-shadow: 0 4px 15px var(--glow-color);
    }
    .timestamp { 
      font-size: 0.75rem; 
      color: var(--text-muted); 
      margin-top: 5px; 
      display: flex; 
      align-items: center; 
      gap: 8px;
    }
    .message.note .timestamp { justify-content: flex-start; }
    .message.user .timestamp { justify-content: flex-end; }
    
    /* --- Image Message --- */
    .message-image {
      border-radius: 20px;
      max-width: 100%;
      height: auto;
      display: block;
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 15px var(--glow-color), 0 4px 15px var(--shadow-color);
      border-bottom-right-radius: 6px;
    }
    
    /* --- Highlight for Important Assistant Messages --- */
    .message.note.assistant-highlight {
      border: 1px solid var(--accent);
      box-shadow: 0 0 10px var(--glow-color);
      padding: 2px;
      border-radius: 22px;
      background: rgba(224, 230, 241, 0.05);
      animation: glow-pulse 2s infinite;
    }
    @keyframes glow-pulse {
      0% { box-shadow: 0 0 10px var(--glow-color), 0 0 20px rgba(224, 230, 241, 0.3); }
      50% { box-shadow: 0 0 15px var(--glow-color), 0 0 30px rgba(224, 230, 241, 0.5); }
      100% { box-shadow: 0 0 10px var(--glow-color), 0 0 20px rgba(224, 230, 241, 0.3); }
    }
    .message.note.assistant-highlight .message-bubble { 
      border-bottom-left-radius: 6px;
      font-weight: 500;
    }

    /* --- Mode Change Message --- */
    .message.note.mode-change {
      border: 1px solid var(--accent);
      box-shadow: 0 0 15px var(--glow-color), 0 0 25px rgba(224, 230, 241, 0.5);
      padding: 2px;
      border-radius: 22px;
      background: rgba(224, 230, 241, 0.1);
      animation: glow-pulse 2s infinite;
    }
    .message.note.mode-change .message-bubble {
      border-bottom-left-radius: 6px;
      font-weight: 500;
    }

    /* --- Wikipedia Result Message --- */
    .message.note.wikipedia-result {
      border: 1px solid var(--accent);
      box-shadow: 0 0 15px var(--glow-color), 0 0 25px rgba(224, 230, 241, 0.5);
      padding: 2px;
      border-radius: 22px;
      background: rgba(224, 230, 241, 0.1);
      animation: glow-pulse 2s infinite;
    }
    .message.note.wikipedia-result .message-bubble {
      border-bottom-left-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .wikipedia-result-image {
      width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 12px;
      align-self: center;
    }
    .wikipedia-result-text {
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .wikipedia-result-link {
      margin-top: 8px;
    }
    .wikipedia-result-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(224, 230, 241, 0.1);
      transition: all 0.2s ease;
    }
    .wikipedia-result-link a:hover {
      background: rgba(224, 230, 241, 0.2);
      text-decoration: underline;
    }

    /* --- Image Analysis Result Message --- */
    .message.note.image-analysis {
      border: 1px solid var(--accent);
      box-shadow: 0 0 15px var(--glow-color), 0 0 25px rgba(224, 230, 241, 0.5);
      padding: 2px;
      border-radius: 22px;
      background: rgba(224, 230, 241, 0.1);
      animation: glow-pulse 2s infinite;
    }
    .message.note.image-analysis .message-bubble {
      border-bottom-left-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .image-analysis-title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .image-analysis-section {
      margin-bottom: 6px;
    }
    .image-analysis-section-title {
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    .image-analysis-content {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 8px;
      font-family: monospace;
    }

    /* --- Infinity Loading Animation --- */
    .loading-indicator {
      display: flex; align-items: center; gap: 10px; padding: 15px 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px; border-bottom-left-radius: 6px;
      box-shadow: 0 4px 15px var(--shadow-color); max-width: 70%; align-self: flex-start;
    }
    .infinity-loader { 
      width: 50px; height: 25px; 
      animation: spin 3s linear infinite; 
    }
    .infinity-loader path {
      stroke: var(--accent); stroke-width: 2.5; fill: none; stroke-linecap: round;
      filter: drop-shadow(0 0 5px var(--glow-color)); 
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); 
    }
    @keyframes pulse-glow { 
      0%, 100% { opacity: 0.8; } 
      50% { opacity: 1; } 
    }

    /* --- Fixed Input Area --- */
    .chat-input-container {
      display: flex; align-items: center; gap: 10px; padding: 20px;
      background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid var(--glass-border);
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
      box-shadow: 0 -4px 20px var(--shadow-color); transform: translateZ(0);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .attachment-btn, .send-btn {
      padding: 12px 18px; border-radius: 24px; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
      font-weight: 500; box-shadow: 0 2px 5px var(--shadow-color);
    }
    .attachment-btn { background: var(--glass-bg); color: var(--text-secondary); border: 1px solid var(--glass-border); }
    .attachment-btn:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
    .send-btn { background: var(--accent); color: var(--bg-gradient-start); box-shadow: 0 2px 10px var(--glow-color); }
    .send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px var(--glow-color); }
    .send-btn:active { transform: scale(0.98); }
    #userInput {
      flex-grow: 1; padding: 12px 18px; border-radius: 24px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary); font-size: 1rem; outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    #userInput:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }
    #userInput::placeholder { color: var(--text-muted); }

    /* --- Header Controls --- */
    .header-controls {
      display: flex;
      gap: 12px;
    }

    .header-action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .header-action-btn:hover {
      color: var(--accent);
      background: rgba(255, 255, 255, 0.05);
    }
    .header-action-btn:active { transform: scale(0.95); }
    .scroll-to-bottom-btn.hidden { opacity: 0; pointer-events: none; }

    .page-watermark {
      position: fixed; bottom: 5px; right: 5px; font-size: 0.6rem;
      color: var(--text-muted); font-family: 'Courier New', Courier, monospace;
      opacity: 0.7; pointer-events: none; z-index: 21;
    }

    /* --- Secret Game Screen --- */
    .game-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 14, 26, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .game-screen.active {
      opacity: 1;
      visibility: visible;
    }

    .game-container {
      width: 95%;
      height: 95vh;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 0 30px var(--glow-color);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      color: var(--accent);
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .game-canvas-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    #gameCanvas {
      background: #000;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      width: 100%;
      height: 100%;
      max-width: 900px;
      max-height: 600px;
      object-fit: contain;
    }

    .game-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
    }

    .game-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--accent);
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px var(--shadow-color);
    }

    .game-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    .game-btn:active {
      transform: scale(0.95);
    }

    .game-instructions {
      padding: 10px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.3);
      font-family: 'Courier New', monospace;
    }

    /* --- Secret Loading Animation --- */
    .secret-loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .secret-loader.active {
      opacity: 1;
      visibility: visible;
    }

    .secret-loader .infinity-loader {
      width: 60px;
      height: 30px;
    }

    /* --- Hidden UI Elements --- */
    .hidden-ui {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    /* --- Mobile Responsive --- */
    @media (max-width: 768px) {
      .game-container {
        width: 98%;
        height: 98vh;
      }
      
      .game-controls {
        gap: 15px;
      }
      
      .game-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
      
      .game-instructions {
        font-size: 0.7rem;
      }
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const chatContainer = document.getElementById("chat-container");
      const chatDiv = document.getElementById("chat");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");
      const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
      const modeToggleBtn = document.getElementById("modeToggleBtn");
      const modeIcon = document.getElementById("modeIcon");
      const noteTitle = document.getElementById("noteTitle");
      const inputContainer = document.getElementById("inputContainer");
      const gameScreen = document.getElementById("gameScreen");
      const gameCanvas = document.getElementById("gameCanvas");
      const ctx = gameCanvas.getContext('2d');
      const secretLoader = document.getElementById("secretLoader");
      
      let isStudyMode = false;
      let conversationHistory = [];
      let activeLoadingProcesses = 0;
      let titleClickCount = 0;
      let titleClickTimer = null;
      
      // --- STATELESS DATA STORAGE (RAM ONLY) ---
      let noteContent = {
        text: "",
        images: [],
        extractedText: [],
        summaries: [],
        actionItems: [],
        multimodalDescriptions: []
      };

      // --- SECRET GAME VARIABLES ---
      let gameRunning = false;
      let playerShip = { x: 0, y: 0, width: 32, height: 32 };
      let bullets = [];
      let enemies = [];
      let stars = [];
      let explosions = [];
      let score = 0;
      let lives = 3;
      let gameAnimationId = null;
      let keys = {};
      let lastEnemySpawn = 0;
      let enemySpawnInterval = 2000; // 2 seconds
      let waveNumber = 1;
      let enemiesInWave = 5;
      let enemiesSpawned = 0;
      let waveComplete = false;
      let waveMessageTimer = 0;
      
      // Set up canvas with pixel art rendering
      ctx.imageSmoothingEnabled = false;

      // --- UI HELPERS ---
      function showLoading() { 
        activeLoadingProcesses++;
        if (activeLoadingProcesses === 1) {
          hideLoading();
          const loaderDiv = document.createElement('div'); 
          loaderDiv.classList.add('message', 'note', 'loading-indicator-wrapper'); 
          loaderDiv.innerHTML = `<div class="loading-indicator"><svg class="infinity-loader" viewBox="0 0 100 40"><path d="M20,20 Q30,5 40,20 T60,20 T80,20" /></svg></div></div>`; 
          chatDiv.appendChild(loaderDiv); 
          chatContainer.scrollTop = chatContainer.scrollHeight; 
        }
      }
      function hideLoading() { 
        activeLoadingProcesses--;
        if (activeLoadingProcesses <= 0) {
          activeLoadingProcesses = 0;
          const existingLoader = chatDiv.querySelector('.loading-indicator-wrapper'); 
          if (existingLoader) { existingLoader.remove(); }
        }
      }
      
      function addMessage(text, sender, extraClass = '') {
        const messageDiv = document.createElement('div'); 
        messageDiv.classList.add('message', sender);
        if(extraClass) messageDiv.classList.add(extraClass);
        
        const bubbleDiv = document.createElement('div'); 
        bubbleDiv.classList.add('message-bubble'); 
        bubbleDiv.textContent = text;
        
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const timestampSpan = document.createElement('span'); 
        timestampSpan.classList.add('timestamp'); 
        timestampSpan.textContent = timestamp;

        messageDiv.appendChild(bubbleDiv); 
        messageDiv.appendChild(timestampSpan); 
        
        chatDiv.appendChild(messageDiv);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        return messageDiv;
      }
      
      function updateConversationHistory(role, content) {
        conversationHistory.push({ role, content, timestamp: Date.now() });
        if (conversationHistory.length > 20) {
          conversationHistory = conversationHistory.slice(-20);
        }
      }
      
      // --- SECRET GAME FUNCTIONS ---
      function initGame() {
        // Set canvas size for pixel art (320x240 scaled up)
        gameCanvas.width = 320;
        gameCanvas.height = 240;
        
        // Initialize player position
        playerShip.x = gameCanvas.width / 2 - playerShip.width / 2;
        playerShip.y = gameCanvas.height - 60;
        
        // Create starfield
        stars = [];
        for (let i = 0; i < 50; i++) {
          stars.push({
            x: Math.random() * gameCanvas.width,
            y: Math.random() * gameCanvas.height,
            size: Math.random() > 0.8 ? 2 : 1,
            speed: Math.random() * 0.5 + 0.1
          });
        }
        
        // Reset game state
        bullets = [];
        enemies = [];
        explosions = [];
        score = 0;
        lives = 3;
        waveNumber = 1;
        enemiesInWave = 5;
        enemiesSpawned = 0;
        waveComplete = false;
        updateGameUI();
        
        // Start game loop
        gameRunning = true;
        gameLoop();
      }
      
      function gameLoop(timestamp) {
        if (!gameRunning) return;
        
        // Clear canvas
        ctx.fillStyle = '#000011';
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
        
        // Update and draw stars
        updateStars();
        
        // Handle wave spawning
        if (enemies.length === 0 && !waveComplete) {
          waveComplete = true;
          waveMessageTimer = 60; // Show message for 1 second at 60fps
        }
        
        if (waveComplete && waveMessageTimer > 0) {
          drawWaveMessage();
          waveMessageTimer--;
          if (waveMessageTimer === 0) {
            waveNumber++;
            enemiesInWave = 5 + waveNumber * 2;
            enemiesSpawned = 0;
            waveComplete = false;
          }
        }
        
        // Spawn enemies in current wave
        if (!waveComplete && enemiesSpawned < enemiesInWave && timestamp - lastEnemySpawn > enemySpawnInterval) {
          spawnEnemy();
          enemiesSpawned++;
          lastEnemySpawn = timestamp;
        }
        
        // Update and draw game objects
        updatePlayer();
        updateBullets();
        updateEnemies();
        updateExplosions();
        checkCollisions();
        
        drawPlayer();
        drawBullets();
        drawEnemies();
        drawExplosions();
        
        // Continue game loop
        gameAnimationId = requestAnimationFrame(gameLoop);
      }
      
      function updateStars() {
        ctx.fillStyle = '#ffffff';
        stars.forEach(star => {
          star.y += star.speed;
          if (star.y > gameCanvas.height) {
            star.y = 0;
            star.x = Math.random() * gameCanvas.width;
          }
          
          ctx.fillRect(star.x, star.y, star.size, star.size);
        });
      }
      
      function updatePlayer() {
        // Keyboard controls
        if (keys['ArrowLeft'] && playerShip.x > 0) {
          playerShip.x -= 4;
        }
        if (keys['ArrowRight'] && playerShip.x < gameCanvas.width - playerShip.width) {
          playerShip.x += 4;
        }
      }
      
      function updateBullets() {
        bullets = bullets.filter(bullet => {
          bullet.y -= 8;
          return bullet.y > 0;
        });
      }
      
      function updateEnemies() {
        enemies = enemies.filter(enemy => {
          enemy.y += enemy.speed;
          
          // Different movement patterns based on enemy type
          if (enemy.type === 'zigzag') {
            enemy.x += Math.sin(enemy.y * 0.05) * 2;
          } else if (enemy.type === 'dive') {
            if (enemy.y > gameCanvas.height / 3) {
              const dx = playerShip.x - enemy.x;
              enemy.x += dx > 0 ? 1 : -1;
            }
          }
          
          return enemy.y < gameCanvas.height + 50;
        });
      }
      
      function updateExplosions() {
        explosions = explosions.filter(explosion => {
          explosion.frame++;
          return explosion.frame < explosion.maxFrames;
        });
      }
      
      function spawnEnemy() {
        const types = ['basic', 'zigzag', 'dive'];
        const type = types[Math.floor(Math.random() * Math.min(types.length, waveNumber))];
        
        enemies.push({
          x: Math.random() * (gameCanvas.width - 32),
          y: -32,
          width: 32,
          height: 32,
          speed: Math.random() * 1.5 + 0.5 + (waveNumber * 0.1),
          type: type,
          color: type === 'basic' ? '#ff3333' : type === 'zigzag' ? '#33ff33' : '#3333ff',
          points: type === 'basic' ? 100 : type === 'zigzag' ? 200 : 300
        });
      }
      
      function drawPlayer() {
        // Draw player ship as pixel art
        ctx.fillStyle = '#00ff00';
        
        // Ship body
        ctx.fillRect(playerShip.x + 14, playerShip.y, 4, 16);
        ctx.fillRect(playerShip.x + 10, playerShip.y + 4, 12, 4);
        ctx.fillRect(playerShip.x + 6, playerShip.y + 8, 20, 4);
        ctx.fillRect(playerShip.x, playerShip.y + 12, 32, 4);
        ctx.fillRect(playerShip.x + 4, playerShip.y + 16, 24, 4);
        ctx.fillRect(playerShip.x + 8, playerShip.y + 20, 16, 4);
        ctx.fillRect(playerShip.x + 12, playerShip.y + 24, 8, 8);
        ctx.fillRect(playerShip.x + 12, playerShip.y + 24, 8, 8);
        
        // Ship details
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(playerShip.x + 14, playerShip.y + 8, 4, 4);
        ctx.fillRect(playerShip.x + 10, playerShip.y + 12, 4, 4);
        ctx.fillRect(playerShip.x + 18, playerShip.y + 12, 4, 4);
      }
      
      function drawBullets() {
        ctx.fillStyle = '#ffff00';
        bullets.forEach(bullet => {
          ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        });
      }
      
      function drawEnemies() {
        enemies.forEach(enemy => {
          ctx.fillStyle = enemy.color;
          
          // Draw enemy ship based on type
          if (enemy.type === 'basic') {
            // Basic enemy ship
            ctx.fillRect(enemy.x + 14, enemy.y + 24, 4, 8);
            ctx.fillRect(enemy.x + 10, enemy.y + 20, 12, 4);
            ctx.fillRect(enemy.x + 6, enemy.y + 16, 20, 4);
            ctx.fillRect(enemy.x, enemy.y + 12, 32, 4);
            ctx.fillRect(enemy.x + 4, enemy.y + 8, 24, 4);
            ctx.fillRect(enemy.x + 8, enemy.y + 4, 16, 4);
            ctx.fillRect(enemy.x + 12, enemy.y, 8, 4);
            ctx.fillRect(enemy.x + 12, enemy.y, 8, 4);
            
            // Enemy details
            ctx.fillStyle = '#000000';
            ctx.fillRect(enemy.x + 10, enemy.y + 12, 4, 4);
            ctx.fillRect(enemy.x + 18, enemy.y + 12, 4, 4);
          } else if (enemy.type === 'zigzag') {
            // Zigzag enemy ship
            ctx.fillRect(enemy.x + 14, enemy.y + 24, 4, 8);
            ctx.fillRect(enemy.x + 6, enemy.y + 20, 20, 4);
            ctx.fillRect(enemy.x, enemy.y + 16, 32, 4);
            ctx.fillRect(enemy.x + 4, enemy.y + 12, 24, 4);
            ctx.fillRect(enemy.x + 8, enemy.y + 8, 16, 4);
            ctx.fillRect(enemy.x + 12, enemy.y + 4, 4);
            ctx.fillRect(enemy.x + 14, enemy.y, 4, 4);
            
            // Enemy details
            ctx.fillStyle = '#000000';
            ctx.fillRect(enemy.x + 8, enemy.y + 12, 4, 4);
            ctx.fillRect(enemy.x + 20, enemy.y + 12, 4, 4);
          } else if (enemy.type === 'dive') {
            // Dive bomber enemy ship
            ctx.fillRect(enemy.x + 14, enemy.y + 24, 4, 8);
            ctx.fillRect(enemy.x + 10, enemy.y + 20, 12, 4);
            ctx.fillRect(enemy.x + 6, enemy.y + 16, 20, 4);
            ctx.fillRect(enemy.x + 2, enemy.y + 12, 28, 4);
            ctx.fillRect(enemy.x, enemy.y + 8, 32, 4);
            ctx.fillRect(enemy.x, enemy.y + 4, 32, 4);
            ctx.fillRect(enemy.x + 4, enemy.y + 4, 24, 4);
            ctx.fillRect(enemy.x + 10, enemy.y, 12, 4, 4);
            
            // Enemy details
            ctx.fillStyle = '#000000';
            ctx.fillRect(enemy.x + 10, enemy.y + 12, 4, 4);
            ctx.fillRect(enemy.x + 18, enemy.y + 12, 4, 4);
            ctx.fillRect(enemy.x + 14, enemy.y + 8, 4, 4);
          }
        });
      }
      
      function drawExplosions() {
        explosions.forEach(explosion => {
          const frame = explosion.frame;
          const maxFrames = explosion.maxFrames;
          
          ctx.fillStyle = `rgba(255, ${255 - frame * 10}, 0, ${1 - frame / maxFrames})`;
          
          // Draw expanding explosion
          const size = frame * 2;
          ctx.fillRect(explosion.x - size/2, explosion.y - size/2, size, size);
          
          // Draw inner explosion
          if (frame > 2) {
            ctx.fillStyle = `rgba(255, 255, 0, ${1 - frame / maxFrames})`;
            ctx.fillRect(explosion.x - size/4, explosion.y - size/4, size/2, size/2);
          }
        });
      }
      
      function drawWaveMessage() {
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(`WAVE ${waveNumber} COMPLETE`, gameCanvas.width / 2, gameCanvas.height / 2);
        ctx.fillText(`PREPARING WAVE ${waveNumber + 1}`, gameCanvas.width / 2, gameCanvas.height / 2 + 20);
      }
      
      function checkCollisions() {
        // Check bullet-enemy collisions
        bullets.forEach((bullet, bulletIndex) => {
          enemies.forEach((enemy, enemyIndex) => {
            if (
              bullet.x < enemy.x + enemy.width &&
              bullet.x + bullet.width > enemy.x &&
              bullet.y < enemy.y + enemy.height &&
              bullet.y + bullet.height > enemy.y
            ) {
              // Remove bullet and enemy
              bullets.splice(bulletIndex, 1);
              enemies.splice(enemyIndex, 1);
              
              // Increase score
              score += enemy.points;
              updateGameUI();
              
              // Create explosion
              createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
            }
          });
        });
        
        // Check player-enemy collisions
        enemies.forEach((enemy, index) => {
          if (
            playerShip.x < enemy.x + enemy.width &&
            playerShip.x + playerShip.width > enemy.x &&
            playerShip.y < enemy.y + enemy.height &&
            playerShip.y + playerShip.height > enemy.y
          ) {
            // Remove enemy
            enemies.splice(index, 1);
            
            // Decrease lives
            lives--;
            updateGameUI();
            
            // Create explosion
            createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
            
            // Check game over
            if (lives <= 0) {
              gameOver();
            }
          }
        });
      }
      
      function createExplosion(x, y) {
        explosions.push({
          x: x,
          y: y,
          frame: 0,
          maxFrames: 20
        });
      }
      
      function fireBullet() {
        bullets.push({
          x: playerShip.x + playerShip.width / 2 - 2,
          y: playerShip.y,
          width: 4,
          height: 8
        });
      }
      
      function updateGameUI() {
        document.getElementById('score').textContent = score;
        document.getElementById('lives').textContent = lives;
      }
      
      function gameOver() {
        gameRunning = false;
        cancelAnimationFrame(gameAnimationId);
        
        // Display game over message
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('GAME OVER', gameCanvas.width / 2, gameCanvas.height / 2 - 30);
        
        ctx.font = '16px monospace';
        ctx.fillText(`FINAL SCORE: ${score}`, gameCanvas.width / 2, gameCanvas.height / 2);
        ctx.fillText(`WAVES COMPLETED: ${waveNumber - 1}`, gameCanvas.width / 2, gameCanvas.height / 2 + 20);
        
        ctx.font = '12px monospace';
        ctx.fillText('CLICK TO RETURN TO NOTE', gameCanvas.width / 2, gameCanvas.height / 2 + 50);
        
        // Add click handler to return to NOTE
        gameCanvas.addEventListener('click', returnToNote, { once: true });
      }
      
      function returnToNote() {
        gameScreen.classList.remove('active');
        document.querySelectorAll('.main-content, .chat-input-container').forEach(el => {
          el.classList.remove('assistant-highlight');
        });
      }
      
      // --- CORE FEATURE FUNCTIONS ---
      async function handleWikipedia(query) {
        try {
          // Use CORS proxy to avoid CORS issues
          const proxyUrl = 'https://api.allorigins.win/raw?url=';
          const wikipediaUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
          
          const response = await fetch(proxyUrl + encodeURIComponent(wikipediaUrl));
          
          if (!response.ok) {
            // Try the original API as fallback
            const fallbackUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages|info&inprop=url&exintro&explaintext&pithumbsize=400&format=json&origin=&titles=${encodeURIComponent(query)}`;
            const fallbackResponse = await fetch(fallbackUrl);
            
            if (!fallbackResponse.ok) throw new Error('Wikipedia API request failed.');
            
            const data = await fallbackResponse.json();
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];

            if (pageId === "-1" || pages[pageId].missing) {
              return null;
            }

            const page = pages[pageId];
            return {
              title: page.title,
              text: page.extract || "No summary available.",
              imageUrl: page.thumbnail ? page.thumbnail.source : null,
              url: page.fullurl || null
            };
          }
          
          const data = await response.json();
          
          return {
            title: data.title,
            text: data.extract || "No summary available.",
            imageUrl: data.thumbnail ? data.thumbnail.source : null,
            url: data.content_urls ? data.content_urls.desktop.page : null
          };
        } catch (error) {
          console.error("Wikipedia error:", error);
          return null;
        }
      }

      function handleMath(expression) {
        try {
          // Simple math evaluation (safe for basic operations)
          const result = Function('"use strict"; return (' + expression + ')')();
          return `The result is: ${result}`;
        } catch (error) {
          return 'I could not solve this math problem. Please check the expression.';
        }
      }

      function handleChart(dataString) {
        return `Chart data received: ${dataString}. (Note: Advanced chart analysis requires AI modules)`;
      }

      function processUploadedContent(imageUrl) {
        // Store image without AI processing
        const imageId = `img_${Date.now()}`;
        noteContent.images.push({ id: imageId, url: imageUrl });
        
        addMessage("Image uploaded successfully. Analyzing content...", "note");
        
        // Create a temporary image element to analyze the image
        const img = new Image();
        img.onload = function() {
          analyzeImage(img, imageId);
        };
        img.src = imageUrl;
      }

      function analyzeImage(img, imageId) {
        // Create a canvas to analyze the image
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size to match image
        canvas.width = img.width;
        canvas.height = img.height;
        
        // Draw image to canvas
        ctx.drawImage(img, 0, 0);
        
        // Get image data
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Analyze the image
        const analysis = analyzeImageData(data, canvas.width, canvas.height);
        
        // Store analysis results
        noteContent.extractedText.push({ 
          imageId, 
          text: analysis.text,
          numbers: analysis.numbers,
          symbols: analysis.symbols,
          diagrams: analysis.diagrams
        });
        
        // Display results
        const messageDiv = addMessage("", "note", "image-analysis");
        const bubbleDiv = messageDiv.querySelector('.message-bubble');
        
        // Add title
        const titleDiv = document.createElement('div');
        titleDiv.className = 'image-analysis-title';
        titleDiv.textContent = 'Image Analysis Results';
        bubbleDiv.appendChild(titleDiv);
        
        // Add text section
        if (analysis.text) {
          const textSection = document.createElement('div');
          textSection.className = 'image-analysis-section';
          const textTitle = document.createElement('div');
          textSection.className = 'image-analysis-section-title';
          textSection.textContent = 'Text Detected:';
          const textContent = document.createElement('div');
          textContent.className = 'image-analysis-content';
          textContent.textContent = analysis.text;
          textSection.appendChild(textContent);
          bubbleDiv.appendChild(textSection);
        }
        
        // Add numbers section
        if (analysis.numbers.length > 0) {
          const numbersSection = document.createElement('div');
          numbersSection.className = 'image-analysis-section';
          const numbersTitle = document.createElement('div');
          numbersTitle.className = 'image-analysis-section-title';
          numbersTitle.textContent = 'Numbers Detected:';
          const numbersContent = document.createElement('div');
          numbersContent.className = 'image-analysis-content';
          numbersContent.textContent = analysis.numbers.join(', ');
          numbersSection.appendChild(numbersContent);
          bubbleDiv.appendChild(numbersSection);
        }
        
        // Add symbols section
        if (analysis.symbols.length > 0) {
          const symbolsSection = document.createElement('div');
          symbolsSection.className = 'image-analysis-section';
          const symbolsTitle = document.createElement('div');
          symbolsTitle = document.createElement('div');
          symbolsTitle.className = 'image-analysis-section-title';
          symbolsTitle.textContent = 'Symbols Detected:';
          const symbolsContent = document.createElement('div');
          symbolsContent.className = 'image-analysis-content';
          symbolsContent.textContent = analysis.symbols.join(', ');
          symbolsSection.appendChild(symbolsContent);
          bubbleDiv.appendChild(symbolsSection);
        }
        
        // Add diagrams section
        if (analysis.diagrams) {
          const diagramsSection = document.createElement('div');
          diagramsSection.className = 'image-analysis-section';
          const diagramsTitle = document.createElement('div');
          diagramsTitle = document.createElement('div');
          diagramsTitle.className = 'image-analysis-section-title';
          diagramsTitle.textContent = 'Diagrams Detected:';
          const diagramsContent = document.createElement('div');
          diagramsContent = document.createElement('div');
          diagramsContent.textContent = 'Diagrams detected in the image.';
          diagramsSection.appendChild(diagramsContent);
          bubbleDiv.appendChild(diagramsSection);
        }
        
        // If nothing was detected
        if (!analysis.text && analysis.numbers.length === 0 && analysis.symbols.length === 0 && !analysis.diagrams) {
          const noResultsSection = document.createElement('div');
          noResultsSection.className = 'image-analysis-section';
          const noResultsTitle = document.createElement('div');
          noResultsTitle = document.createElement('div');
          noResultsTitle.className = 'image-analysis-section-title';
          noResultsTitle.textContent = 'Analysis Results:';
          const noResultsContent = document.createElement('div');
          noResultsContent.textContent = 'No recognizable text, numbers, symbols, or diagrams detected in this image.';
          noResultsContent.appendChild(noResultsContent);
          noResultsSection.appendChild(noResultsTitle);
          bubbleDiv.appendChild(noResultsSection);
        }
        
        updateConversationHistory("assistant", "Image analysis complete");
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function analyzeImageData(data, width, height) {
        const result = {
          text: "",
          numbers: [],
          symbols: [],
          diagrams: false
        };
        
        // Sample pixels at regular intervals
        const sampleSize = Math.min(100, width * height / 1000);
        const stepX = Math.floor(width / Math.sqrt(sampleSize));
        const stepY = Math.floor(height / Math.sqrt(sampleSize));
        
        let darkPixels = 0;
        let lightPixels = 0;
        let redPixels = 0;
        let bluePixels = 0;
        let greenPixels = 0;
        
        // Sample pixels to detect patterns
        for (let y = 0; y < height; y += stepY) {
          for (let x = 0; x < width; x += stepX) {
            const i = (y * width + x) * 4;
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const a = data[i + 3];
            
            if (a > 0) { // Only consider non-transparent pixels
              const brightness = (r + g + b) / 3;
              
              if (brightness < 50) darkPixels++;
              else if (brightness > 200) lightPixels++;
              
              if (r > 150 && g < 100 && b < 100 && b < 100) redPixels++;
              else if (r < 100 && g > 150 && b < 100) greenPixels++;
              else if (r < 100 && g < 100 && b > 150) bluePixels++;
            }
          }
        }
        
        // Determine if it might be a diagram based on color distribution
        const totalPixels = darkPixels + lightPixels;
        if (totalPixels > 0) {
          const darkRatio = darkPixels / totalPixels;
          const colorVariety = (redPixels + greenPixels + bluePixels) / totalPixels;
          
          // If there's a good balance of dark/light pixels and some color variety, it might be a diagram
          if (darkRatio > 0.2 && darkRatio < 0.8 && colorVariety > 0.1) {
            result.diagrams = true;
          }
        }
        
        // This is a placeholder for actual OCR functionality
        // In a real implementation, you'd use a proper OCR library
        result.text = "Text detection requires OCR library";
        result.numbers = ["1", "2", "3"]; // Placeholder
        result.symbols = ["+", "="]; // Placeholder
        
        return result;
      }

      function generateResponse(query) {
        const lowerQuery = query.toLowerCase();
        
        // Enhanced conversation skills with context awareness
        if (lowerQuery.includes('hello') || lowerQuery.includes('hi')) {
          return "Hello! I'm NOTE, your intelligent note-taking assistant. How can I help you today?";
        }
        
        if (lowerQuery.includes('how are you')) {
          return "I'm functioning perfectly, thank you for asking! I'm ready to help you with your notes and questions.";
        }
        
        if (lowerQuery.includes('what can you do') || lowerQuery.includes('help')) {
          let helpText = `I can help you with:
• Saving and organizing text notes
• Analyzing images for text, numbers, symbols, and diagrams
• Basic math calculations (use "math: expression")
• Wikipedia lookups (use "wiki: topic") - ${isStudyMode ? 'Available' : 'Only in Study Mode'}
• Simple chart data notes (use "chart: data")

Current mode: ${isStudyMode ? 'Study Mode' : 'Normal Mode'}

${isStudyMode ? 'In Study Mode, I have enhanced capabilities for research and learning.' : 'In Normal Mode, I focus on basic note-taking functionality.'}

Note: Advanced AI features have been disabled for a lightweight experience.

PS: Try clicking the NOTE title 5 times quickly for a surprise...`;
          return helpText;
        }
        
        if (lowerQuery.includes('thank')) {
          return "You're welcome! I'm always here to help with your notes and questions. Is there anything else you'd like to know?";
        }
        
        if (lowerQuery.includes('what is your name')) {
          return "I'm NOTE, your intelligent note-taking assistant. I was created to help you organize information and answer your questions.";
        }
        
        if (lowerQuery.includes('who created you')) {
          return "I was created by hafij shaikh as a lightweight note-taking assistant with a beautiful Cosmic Midnight interface.";
        }
        
        // Check if this is a question
        if (lowerQuery.includes('?') || lowerQuery.includes('what') || lowerQuery.includes('how') || lowerQuery.includes('why') || lowerQuery.includes('where') || lowerQuery.includes('when') || lowerQuery.includes('who')) {
          // This is likely a question, so we should add the assistant-highlight class
          return {
            text: generateDetailedResponse(query),
            isImportant: true
          };
        }
        
        // Default response with more personality
        const responses = [
          "I'm a simple note-taking assistant. I've saved your message. Type 'help' to see what I can do.",
          "Message received and stored! Is there anything specific you'd like to know about what I can help with?",
          "I've noted that down. Feel free to ask me questions or use commands like 'math:' or 'wiki:'.",
          "Got it! I'm here to help with your notes and questions. What would you like to explore next?"
        ];
        
        return {
          text: responses[Math.floor(Math.random() * responses.length)],
          isImportant: false
        };
      }

      function generateDetailedResponse(query) {
        const lowerQuery = query.toLowerCase();
        
        // Handle specific types of questions
        if (lowerQuery.includes('what') || lowerQuery.includes('what are') || lowerQuery.includes('what is')) {
          if (lowerQuery.includes('note') || lowerQuery.includes('this app')) {
            return "NOTE is your intelligent note-taking assistant. I'm designed to help you organize information, analyze images, and access knowledge through Wikipedia in Study Mode.";
          }
          
          if (lowerQuery.includes('cosmic midnight')) {
            return "Cosmic Midnight is the beautiful theme of this application, featuring a dark background with stars and a glowing moon, creating a serene atmosphere for your note-taking experience.";
          }
          
          if (lowerQuery.includes('study mode')) {
            return "Study Mode enhances my capabilities with research features like Wikipedia lookups and detailed image analysis. It's perfect for learning and research tasks.";
          }
          
          if (lowerQuery.includes('normal mode')) {
            return "Normal Mode focuses on basic note-taking functionality with a simplified interface, perfect for quick notes and basic tasks.";
          }
        }
          
          if (lowerQuery.includes('cosmic midnight')) {
            return "Cosmic Midnight is the beautiful theme of this application, featuring a dark background with stars and a glowing moon, creating a serene atmosphere for your note-taking experience.";
          }
          
          if (lowerQuery.includes('study mode')) {
            return "Study Mode enhances my capabilities with research features like Wikipedia lookups and detailed image analysis. It's perfect for learning and research tasks.";
          }
          
          if (lowerQuery.includes('normal mode')) {
            return "Normal Mode focuses on basic note-taking functionality with a simplified interface, perfect for quick notes and basic tasks.";
          }
          
          // If we don't have specific information about what "what" refers to, we need to look at the context
          if (conversationHistory.length > 0) {
            const lastUserMessage = conversationHistory[conversationHistory.length - 1];
            if (lastUserMessage.role === 'user') {
              const lastMessage = lastUserMessage.content.toLowerCase();
              
              if (lastMessage.includes('image') && lowerQuery.includes('what')) {
                return "Based on the image you shared, I've analyzed it for text, numbers, symbols, and diagrams. You can ask me specific questions about what I found.";
              }
              
              if (lastMessage.includes('math:') && lowerQuery.includes('correct')) {
                return "I try my best with math calculations, but for complex equations, you might want to double-check with a calculator. I'm always learning to improve!";
              }
            }
            }
          }
        }
        
        // Check if this is a question
        if (lowerQuery.includes('?') || lowerQuery.includes('what') || lowerQuery.includes('how') || lowerQuery.includes('why') || lowerQuery.includes('where') || lowerQuery.includes('when') || lowerQuery.includes('who')) {
          // This is likely a question, so we should add the assistant-highlight class
          return {
            text: generateDetailedResponse(query),
            isImportant: true
          };
        }
        
        // Default response for other questions
        return {
          text: "That's an interesting question! I'm designed to help with note-taking and information retrieval. Is there anything specific you'd like to know?",
          text: generateDetailedResponse(query),
          isImportant: true
        };
      }

      // --- MAIN MESSAGE HANDLING ---
      async function handleUserMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        
        addMessage(message, "user");
        updateConversationHistory("user", message);
        userInput.value = "";
        
        // Handle special commands
        if (message.toLowerCase().startsWith("math:")) {
          const expression = message.substring(5).trim();
          const result = handleMath(expression);
          addMessage(result, "note", "assistant-highlight");
          updateConversationHistory("assistant", result);
          return;
        }
        
        if (message.toLowerCase().startsWith("wiki:")) {
          const query = message.substring(5).trim();
          showLoading();
          const result = await handleWikipedia(query);
          hideLoading();
          if (result) {
            addWikipediaMessage(result.title, result.text, result.imageUrl, result.url);
            updateConversationHistory("assistant", result.text);
          } else {
            addMessage("I couldn't find information on that topic. Please try a different search term.", "note");
            updateConversationHistory("assistant", "No Wikipedia result found");
          }
          return;
        }
        
        if (message.toLowerCase().startsWith("chart:")) {
          const dataString = message.substring(6).trim();
          const result = handleChart(dataString);
          addMessage(result, "note", "assistant-highlight");
          updateConversationHistory("assistant", result);
          return;
        }
        
        // Default: Generate response
        const response = generateResponse(message);
        
        if (typeof response === 'object' && response.isImportant) {
          addMessage(response.text, "note", "assistant-highlight");
        } else {
          addMessage(response.text, "note");
        }
        
        updateConversationHistory("assistant", response.text);
      }

      function addWikipediaMessage(title, text, imageUrl, url) {
        const messageDiv = document.createElement('div'); 
        messageDiv.classList.add('message', 'note', 'wikipedia-result');
        
        const bubbleDiv = document.createElement('div'); 
        bubbleDiv.classList.add('message-bubble');
        
        // Add title
        const titleDiv = document.createElement('div');
        titleDiv.textContent = title;
        titleDiv.style.margin = '0 0 0 8px 0 8px';
        titleDiv.style.color = 'var(--accent)';
        titleDiv.style.fontSize = '1.1rem';
        titleDiv.style.fontWeight = '600';
        titleDiv.style.marginBottom = '4px';
        titleDiv.style.textShadow = '0 0 10px var(--glow-color)';
        bubbleDiv.appendChild(titleDiv);
        
        // Add image if available
        if (imageUrl) {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.classList.add('wikipedia-result-image');
            img.classList.add('wikipedia-result-image');
            bubbleDiv.appendChild(img);
        }
        
        // Add text
        if (text) {
            const textP = document.createElement('p');
            textP.classList.add('wikipedia-result-text');
            textP.textContent = text;
            bubbleDiv.appendChild(textP);
        }
        
        // Add link if available
        if (url) {
          const linkDiv = document.createElement('div');
          linkDiv.className = 'wikipedia-result-link';
          const link = document.createElement('a');
          link.href = url;
          link.textContent = "Read more on Wikipedia →";
          link.target = "_blank";
          link.style.color = 'var(--accent)';
          link.style.textDecoration = 'none';
          link.style.fontWeight = '500';
          link.style.padding = '4px 8px';
          link.style.borderRadius = '8px';
          link.style.background = 'rgba(224, 230, 241, 0.1)';
          link.style.transition = 'all 0.2s ease';
          link.addEventListener('click', function(e) { e.preventDefault(); });
          linkDiv.appendChild(link);
          linkDiv.appendChild(linkDiv);
          bubbleDiv.appendChild(linkDiv);
        }
        
        // Add timestamp
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const timestampSpan = document.createElement('span'); 
        timestampSpan.classList.add('timestamp'); 
        timestampSpan.textContent = timestamp;

        messageDiv.appendChild(bubbleDiv); 
        messageDiv.appendChild(timestampSpan); 
        
        chatDiv.appendChild(messageDiv);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        return messageDiv;
      }

      // --- EVENT LISTENERS ---
      sendBtn.addEventListener("click", handleUserMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleUserMessage();
        }
      });
      
      uploadBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const imageUrl = e.target.result;
            addMessage("", "user");
            const imageMsg = chatDiv.lastElementChild;
            const img = document.createElement("img");
            img.src = imageUrl;
            img.classList.add("message-image");
            imageMsg.querySelector(".message-bubble").replaceWith(img);
            updateConversationHistory("user", "[Image uploaded]");
            processUploadedContent(imageUrl);
          };
          reader.readAsDataURL(file);
        }
        e.target.value = "";
      });
      
      // Scroll to bottom functionality
      chatContainer.addEventListener("scroll", () => {
        const isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50;
        scrollToBottomBtn.classList.toggle("hidden", isAtBottom);
      });
      
      scrollToBottomBtn.addEventListener("click", () => {
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      });
      
      // Mode toggle button - single button to toggle between Study and Normal mode
      modeToggleBtn.addEventListener("click", () => {
        isStudyMode = !isStudyMode;
        
        // Update icon based on mode
        if (isStudyMode) {
          modeIcon.className = "fas fa-book-open";
        } else {
          modeIcon.className = "fas fa-gamepad";
        }
        
        // Update button color
        modeToggleBtn.style.color = isStudyMode ? "var(--accent)" : "var(--text-muted)";
        
        // Add mode change message with glow effect
        const modeMessage = isStudyMode ? 
          "Study Mode Enabled - Enhanced research capabilities are now available including Wikipedia lookups and detailed image analysis." : 
          "Normal Mode Enabled - Focused on basic note-taking functionality with simplified interface.";
        
        addMessage(modeMessage, "note", "mode-change");
        updateConversationHistory("assistant", modeMessage);
      });
      
      // Secret title click handler
      noteTitle.addEventListener("click", () => {
        titleClickCount++;
        
        // Clear previous timer
        if (titleClickTimer) {
          clearTimeout(titleClickTimer);
        }
        
        // Set new timer to reset click count after 2 seconds
        titleClickTimer = setTimeout(() => {
          titleClickCount = 0;
        }, 2000);
        
        // Check if clicked 5 times
        if (titleClickCount === 5) {
          titleClickCount = 0;
          activateSecretGame();
        }
      });
      
      function activateSecretGame() {
        // Show secret loader
        secretLoader.classList.add('active');
        
        // Blur background
        document.body.style.filter = 'blur(5px)';
        
        // After 5 seconds, hide loader and start game
        setTimeout(() => {
          // Hide loader
          secretLoader.classList.remove('active');
          
          // Reset blur
          document.body.style.filter = '';
          
          // Hide UI elements
          document.querySelectorAll('.main-content, .chat-input-container').forEach(el => {
            el.classList.add('hidden-ui');
          });
          
          // Show game screen
          gameScreen.classList.add('active');
          
          // Initialize game
          initGame();
        }, 5000);
      }
      
      // Game controls
      document.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        keys[e.key] = true;
        
        if (e.key === ' ') {
          e.preventDefault();
          fireBullet();
        }
      });
      
      document.addEventListener('keyup', (e) => {
        if (!gameRunning) return;
        keys[e.key] = false;
      });
      
      // Mobile game controls
      document.getElementById('leftBtn').addEventListener('click', () => {
        if (!gameRunning) return;
        if (playerShip.x > 0) playerShip.x -= 20;
      });
      
      document.getElementById('rightBtn').addEventListener('click', () => {
        if (!gameRunning) return;
        if (playerShip.x < gameCanvas.width - playerShip.width) playerShip.x += 20;
      });
      
      document.getElementById('fireBtn').addEventListener('click', () => {
        if (!gameRunning) return;
        fireBullet();
      });
      
      // No initial welcome message - removed as requested
    });
    });
  </script>
</body>
</html>
