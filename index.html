<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Note</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <style>
    :root {
      --bg-gradient-start: #0a0e1a;
      --bg-gradient-end: #050510;
      --glass-bg: rgba(20, 25, 40, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #b8c5d6;
      --text-secondary: #a0b0c5;
      --text-muted: #7a8ca0;
      --accent: #e0e6f1;
      --accent-hover: #f0f4f8;
      --shadow-color: rgba(0, 0, 0, 0.4);
      --glow-color: rgba(224, 230, 241, 0.3);
    }

    html, body { margin: 0; padding: 0; height: 100%; min-height: 100%; }
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-gradient-start); 
      color: var(--text-primary); 
      overflow: hidden; 
      position: relative;
    }

    .cosmos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

    .moon {
      position: absolute; top: 15%; right: 20%; width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(224, 230, 241, 0.2) 0%, rgba(224, 230, 241, 0.05) 60%, transparent 100%);
      border-radius: 50%; filter: blur(2px); box-shadow: 0 0 50px var(--glow-color);
    }

    .stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: radial-gradient(1px 1px at 50px 100px, #fff, transparent), 
                        radial-gradient(1px 1px at 150px 250px, #fff, transparent),
                        radial-gradient(1px 1px at 250px 50px, #fff, transparent),
                        radial-gradient(1px 1px at 350px 150px, #fff, transparent);
      background-repeat: repeat; background-size: 600px 400px; opacity: 0.5; 
      animation: twinkle 10s infinite ease-in-out; will-change: opacity;
    }

    @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

    .app-container { display: flex; flex-direction: column; height: 100vh; position: relative; z-index: 1; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-header { display: flex; justify-content: center; align-items: center; padding: 20px; flex-shrink: 0; background: transparent; }
    .conversation-title { font-size: 1.5rem; font-weight: 600; color: var(--accent); text-shadow: 0 0 10px var(--glow-color); }

    .chat-container { 
      flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; background: transparent; 
      scrollbar-width: none; -ms-overflow-style: none; will-change: scroll-position;
    }
    .chat-container::-webkit-scrollbar { display: none; }
    #chat { display: flex; flex-direction: column; gap: 15px; }

    .message { display: flex; flex-direction: column; max-width: 70%; touch-action: pan-y; transition: transform 0.2s ease-out; position: relative; will-change: transform; }
    .message.assistant { align-self: flex-start; }
    .message.user { align-self: flex-end; }

    .message-bubble {
      padding: 12px 18px; border-radius: 20px; line-height: 1.5; word-wrap: break-word;
      box-shadow: 0 4px 15px var(--shadow-color); white-space: pre-line;
    }

    .message.assistant .message-bubble {
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); color: var(--text-primary); border-bottom-left-radius: 6px;
    }

    .message.user .message-bubble {
      background: var(--accent); color: var(--bg-gradient-start); font-weight: 500;
      border-bottom-right-radius: 6px; box-shadow: 0 4px 15px var(--glow-color);
    }

    .message-image {
      max-width: 100%; height: auto; border-radius: 12px; margin-top: 10px;
      border: 1px solid var(--glass-border); box-shadow: 0 4px 15px var(--shadow-color);
    }

    .timestamp { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: flex; align-items: center; gap: 8px; }
    .message.assistant .timestamp { justify-content: flex-start; }
    .message.user .timestamp { justify-content: flex-end; }

    /* INFINITY LOADER - SMALLER SIZE */
    .typing-indicator {
      display: flex; align-items: center; gap: 10px; padding: 15px 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px; border-bottom-left-radius: 6px;
      box-shadow: 0 4px 15px var(--shadow-color); max-width: 70%; align-self: flex-start;
    }

    .infinity-loader { 
      width: 35px;  /* Reduced from 50px */
      height: 18px;  /* Reduced from 25px */
      animation: spin 3s linear infinite; 
    }

    .infinity-loader path {
      stroke: var(--accent); 
      stroke-width: 2.5; 
      fill: none; 
      stroke-linecap: round;
      filter: drop-shadow(0 0 5px var(--glow-color)); 
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }

    @keyframes pulse-glow { 
      0%, 100% { opacity: 0.8; } 
      50% { opacity: 1; } 
    }

    .chat-input-container {
      display: flex; align-items: center; gap: 10px; padding: 20px;
      background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid var(--glass-border); position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
      box-shadow: 0 -4px 20px var(--shadow-color); transform: translateZ(0); will-change: transform;
    }

    .send-btn {
      padding: 12px 18px; border-radius: 24px; border: none; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; font-weight: 500; 
      will-change: transform, box-shadow; background: var(--accent); color: var(--bg-gradient-start); 
      box-shadow: 0 2px 10px var(--glow-color);
    }
    .send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px var(--glow-color); }
    .send-btn:active { transform: scale(0.98); }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    #userInput {
      flex-grow: 1; padding: 12px 18px; border-radius: 24px; border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05); color: var(--text-primary); font-size: 1rem; outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    #userInput:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }
    #userInput::placeholder { color: var(--text-muted); }

    .action-btn {
      position: fixed; bottom: 100px; width: 48px; height: 48px; border-radius: 50%;
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); color: var(--accent); font-size: 1.1rem; cursor: pointer; 
      display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; 
      box-shadow: 0 4px 15px var(--shadow-color); z-index: 15; will-change: transform, box-shadow;
    }
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1); color: var(--accent-hover);
      box-shadow: 0 0 15px var(--glow-color); transform: scale(1.05);
    }
    .action-btn:active { transform: scale(0.95); }
    .scroll-to-bottom-btn { right: 20px; }
    .scroll-to-bottom-btn.hidden { opacity: 0; pointer-events: none; transform: scale(0.8); }

    @media (max-width: 768px) {
      .message { max-width: 85%; }
      .main-header { padding: 15px; }
      .conversation-title { font-size: 1.3rem; }
      .chat-input-container { padding: 15px; }
      .action-btn { bottom: 90px; width: 44px; height: 44px; }
    }

    @media (max-width: 480px) {
      .message { max-width: 90%; }
      .main-header { padding: 10px; }
      .conversation-title { font-size: 1.2rem; }
      .chat-input-container { padding: 10px; gap: 8px; }
      .send-btn { padding: 10px 15px; }
      #userInput { padding: 10px 15px; font-size: 0.9rem; }
      .action-btn { bottom: 80px; width: 40px; height: 40px; }
    }
  </style>
</head>
<body>

  <div class="cosmos">
    <div class="moon"></div>
    <div class="stars"></div>
  </div>

  <div class="app-container">
    <main class="main-content">
      <header class="main-header">
        <h1 class="conversation-title">Note</h1>
      </header>

      <div class="chat-container" id="chat-container">
        <div id="chat">
          <!-- Chat messages will appear here -->
        </div>
      </div>
    </main>
  </div>

  <footer class="chat-input-container">
    <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off">
    <button class="send-btn" id="sendBtn">Send</button>
  </footer>

  <button class="action-btn scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to Bottom">
    <i class="fas fa-chevron-down"></i>
  </button>

  <script>
    // ⚠️ REPLACE WITH YOUR API KEY from: https://codewords.agemo.ai/account/keys
    const NOTE_API_KEY = 'YOUR_API_KEY_HERE';
    const NOTE_API_URL = 'https://runtime.codewords.ai/run/note_chatbot_b9e8f37e';

    document.addEventListener("DOMContentLoaded", function() {
      const chatContainer = document.getElementById("chat-container");
      const chatDiv = document.getElementById("chat");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
      
      let isTyping = false;

      function addMessage(text, sender) {
        const messageDiv = document.createElement('div'); 
        messageDiv.classList.add('message', sender);
        
        const bubbleDiv = document.createElement('div'); 
        bubbleDiv.classList.add('message-bubble');
        
        // Handle markdown images: ![alt](url)
        const imageRegex = /!\[.*?\]\((https?:\/\/[^\)]+)\)/g;
        let images = [];
        let match;
        
        while ((match = imageRegex.exec(text)) !== null) {
          images.push(match[1]);
        }
        
        // Remove markdown image syntax from text
        const cleanText = text.replace(imageRegex, '').trim();
        bubbleDiv.textContent = cleanText;
        
        // Add images
        images.forEach(imageUrl => {
          const img = document.createElement('img');
          img.src = imageUrl;
          img.classList.add('message-image');
          img.alt = 'Image';
          img.loading = 'lazy';
          img.onerror = function() { this.style.display = 'none'; };
          bubbleDiv.appendChild(img);
        });
        
        const timestamp = getCurrentTimestamp();
        const timestampSpan = document.createElement('span'); 
        timestampSpan.classList.add('timestamp'); 
        timestampSpan.textContent = timestamp;

        messageDiv.appendChild(bubbleDiv); 
        messageDiv.appendChild(timestampSpan); 
        chatDiv.appendChild(messageDiv);
        scrollToBottom();
        
        return messageDiv;
      }

      function showTypingIndicator() {
        if (isTyping) return null;
        
        isTyping = true;
        const typingDiv = document.createElement('div'); 
        typingDiv.classList.add('message', 'assistant', 'typing-indicator');
        typingDiv.innerHTML = `
          <svg class="infinity-loader" viewBox="0 0 100 40">
            <path d="M20,20 Q30,5 40,20 T60,20 T80,20" />
          </svg>
        `;
        chatDiv.appendChild(typingDiv);
        scrollToBottom();
        
        return typingDiv;
      }

      function hideTypingIndicator(typingDiv) {
        if (typingDiv && typingDiv.parentNode) {
          typingDiv.remove();
        }
        isTyping = false;
      }

      function getCurrentTimestamp() {
        return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function scrollToBottom() {
        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });
      }

      function isEmpty(str) {
        return !str || str.trim().length === 0;
      }

      // Note API integration (FIXED!)
      async function callNoteAPI(message) {
        try {
          const response = await fetch(NOTE_API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${NOTE_API_KEY}`
            },
            body: JSON.stringify({ 
              message: message,
              show_stats: false
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('API Error:', response.status, errorData);
            throw new Error(`API Error: ${response.status} - ${errorData.detail || response.statusText}`);
          }

          const data = await response.json();
          
          // Note returns 'response' field
          return data.response || "I'm sorry, I couldn't process that request.";
          
        } catch (error) {
          console.error('Note API Error:', error);
          throw error;
        }
      }

      async function handleSendMessage() {
        const messageText = userInput.value.trim();
        if (isEmpty(messageText)) return;
        
        // Disable input while processing
        userInput.disabled = true;
        sendBtn.disabled = true;
        
        // Add user message
        addMessage(messageText, "user");
        userInput.value = '';
        
        // Show typing indicator
        const typingIndicator = showTypingIndicator();
        
        try {
          // Call Note API
          const response = await callNoteAPI(messageText);
          
          // Hide typing indicator
          hideTypingIndicator(typingIndicator);
          
          // Add assistant response
          addMessage(response, "assistant");
        } catch (error) {
          // Hide typing indicator
          hideTypingIndicator(typingIndicator);
          
          // Show error message
          addMessage("Sorry, I encountered an error. Please check the console and your API key!", "assistant");
        } finally {
          // Re-enable input
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          handleSendMessage();
        }
      }

      function handleScroll() {
        if (chatContainer.scrollTop < chatContainer.scrollHeight - chatContainer.clientHeight - 100) { 
          scrollToBottomBtn.classList.remove('hidden'); 
        } else { 
          scrollToBottomBtn.classList.add('hidden'); 
        }
      }

      // Event listeners
      sendBtn.addEventListener('click', handleSendMessage);
      userInput.addEventListener('keypress', handleKeyPress);
      scrollToBottomBtn.addEventListener('click', scrollToBottom);
      
      // Throttled scroll handler for performance
      let scrollTimeout;
      chatContainer.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(handleScroll, 100);
      });

      // Focus input on load
      userInput.focus();
    });
  </script>
</body>
</html>
