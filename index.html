<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOTE - Cosmic Midnight</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <!-- Include Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- Include Math.js for advanced calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <!-- Include Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- Cosmic Midnight Color Palette --- */
    :root {
      --bg-gradient-start: #0a0e1a;
      --bg-gradient-end: #050510;
      --glass-bg: rgba(20, 25, 40, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #b8c5d6;
      --text-secondary: #a0b0c5;
      --text-muted: #7a8ca0;
      --accent: #e0e6f1;
      --accent-hover: #f0f4f8;
      --shadow-color: rgba(0, 0, 0, 0.4);
      --glow-color: rgba(224, 230, 241, 0.3);
    }

    html, body { margin: 0; padding: 0; height: 100%; min-height: 100%; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-gradient-start); color: var(--text-primary); overflow: hidden; position: relative;
    }

    /* --- Simple Moon and Stars Background --- */
    .cosmos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .moon {
      position: absolute; top: 15%; right: 20%; width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(224, 230, 241, 0.2) 0%, rgba(224, 230, 241, 0.05) 60%, transparent 100%);
      border-radius: 50%; filter: blur(2px); box-shadow: 0 0 50px var(--glow-color);
    }
    .stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: radial-gradient(1px 1px at 50px 100px, #fff, transparent), radial-gradient(1px 1px at 150px 250px, #fff, transparent);
      background-repeat: repeat; background-size: 600px 400px; opacity: 0.5; animation: twinkle 10s infinite ease-in-out;
    }
    @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

    .app-container { display: flex; flex-direction: column; height: 100vh; position: relative; z-index: 1; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px; 
      flex-shrink: 0; 
      background: transparent; 
    }
    .conversation-title { font-size: 1.5rem; font-weight: 600; display: flex; align-items: baseline; gap: 8px; color: var(--accent); text-shadow: 0 0 5px var(--glow-color); }
    .title-credit { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; text-shadow: none; }
    
    .header-actions {
        display: flex;
        gap: 10px;
    }

    .chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; background: transparent; scrollbar-width: none; -ms-overflow-style: none; }
    .chat-container::-webkit-scrollbar { display: none; }
    #chat { display: flex; flex-direction: column; gap: 15px; }

    /* --- Messages --- */
    .message { 
      display: flex; 
      flex-direction: column; 
      max-width: 70%; 
      transition: transform 0.2s ease-out;
      position: relative;
    }
    .message.note { align-self: flex-start; }
    .message.user { align-self: flex-end; }
    .message-bubble {
      padding: 12px 18px; border-radius: 20px; line-height: 1.5; word-wrap: break-word;
      box-shadow: 0 4px 15px var(--shadow-color);
    }
    .message.note .message-bubble {
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); color: var(--text-primary); border-bottom-left-radius: 6px;
    }
    .message.user .message-bubble {
      background: var(--accent); color: var(--bg-gradient-start); font-weight: 500;
      border-bottom-right-radius: 6px; box-shadow: 0 4px 15px var(--glow-color);
    }
    .timestamp { 
      font-size: 0.75rem; 
      color: var(--text-muted); 
      margin-top: 5px; 
      display: flex; 
      align-items: center; 
      gap: 8px;
    }
    .message.note .timestamp { justify-content: flex-start; }
    .message.user .timestamp { justify-content: flex-end; }
    
    /* --- Image Message --- */
    .message-image {
      border-radius: 20px;
      max-width: 100%;
      height: auto;
      display: block;
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 15px var(--glow-color), 0 4px 15px var(--shadow-color);
      border-bottom-right-radius: 6px;
    }
    
    /* --- Chart Canvas --- */
    .message-bubble canvas {
      max-width: 100%;
      height: auto !important;
      border-radius: 10px;
      margin-top: 10px;
    }

    /* --- Highlight for Important Assistant Messages --- */
    .message.note.assistant-highlight {
      border: 1px solid var(--accent);
      box-shadow: 0 0 10px var(--glow-color);
      padding: 2px;
      border-radius: 22px;
      background: rgba(224, 230, 241, 0.05);
    }
    .message.note.assistant-highlight .message-bubble { border-bottom-left-radius: 6px; }
    
    /* --- OCR Result Message --- */
    .message.note.ocr-result .message-bubble {
        background: rgba(255, 235, 59, 0.1);
        border-left: 3px solid rgba(255, 235, 59, 0.5);
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
    }
    
    /* --- Math Solution Message --- */
    .message.note.math-solution .message-bubble {
        background: rgba(100, 200, 255, 0.1);
        border-left: 3px solid rgba(100, 200, 255, 0.5);
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
    }

    /* --- Infinity Loading Animation --- */
    .loading-indicator {
      display: flex; align-items: center; gap: 10px; padding: 15px 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px; border-bottom-left-radius: 6px;
      box-shadow: 0 4px 15px var(--shadow-color); max-width: 70%; align-self: flex-start;
    }
    .infinity-loader { 
      width: 50px; height: 25px; 
      animation: spin 3s linear infinite; 
    }
    .infinity-loader path {
      stroke: var(--accent); stroke-width: 2.5; fill: none; stroke-linecap: round;
      filter: drop-shadow(0 0 5px var(--glow-color)); 
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }
    @keyframes pulse-glow { 
      0%, 100% { opacity: 0.8; } 
      50% { opacity: 1; } 
    }

    /* --- Fixed Input Area --- */
    .chat-input-container {
      display: flex; align-items: center; gap: 10px; padding: 20px;
      background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid var(--glass-border);
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
      box-shadow: 0 -4px 20px var(--shadow-color); transform: translateZ(0);
    }
    .attachment-btn, .send-btn {
      padding: 12px 18px; border-radius: 24px; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
      font-weight: 500; box-shadow: 0 2px 5px var(--shadow-color);
    }
    .attachment-btn { background: var(--glass-bg); color: var(--text-secondary); border: 1px solid var(--glass-border); }
    .attachment-btn:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
    .send-btn { background: var(--accent); color: var(--bg-gradient-start); box-shadow: 0 2px 10px var(--glow-color); }
    .send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px var(--glow-color); }
    .send-btn:active { transform: scale(0.98); }
    #userInput {
      flex-grow: 1; padding: 12px 18px; border-radius: 24px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary); font-size: 1rem; outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    #userInput:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }
    #userInput::placeholder { color: var(--text-muted); }

    /* --- Action Buttons in Header --- */
    .action-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); color: var(--accent); font-size: 1rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; box-shadow: 0 4px 15px var(--shadow-color);
    }
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1); color: var(--accent-hover);
      box-shadow: 0 0 15px var(--glow-color); transform: scale(1.05);
    }
    .action-btn:active { transform: scale(0.95); }
    .scroll-to-bottom-btn.hidden { opacity: 0.4; pointer-events: none; transform: scale(0.9); }

    .page-watermark {
      position: fixed; bottom: 5px; right: 5px; font-size: 0.6rem;
      color: var(--text-muted); font-family: 'Courier New', Courier, monospace;
      opacity: 0.7; pointer-events: none; z-index: 21;
    }
  </style>
</head>
<body>

  <!-- Simple Moon and Stars Background -->
  <div class="cosmos">
    <div class="moon"></div>
    <div class="stars"></div>
  </div>

  <div class="app-container">
    <!-- Main Chat Area -->
    <main class="main-content">
      <header class="main-header">
        <h1 class="conversation-title">
          NOTE
          <span class="title-credit">by hafij shaikh</span>
        </h1>
        <div class="header-actions">
            <button class="action-btn scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to Bottom">
                <i class="fas fa-chevron-down"></i>
            </button>
            <button class="action-btn mode-toggle-btn" id="modeToggleBtn" title="Toggle Conversation Mode">
                <i class="fas fa-brain"></i>
            </button>
        </div>
      </header>

      <div class="chat-container" id="chat-container">
        <div id="chat">
          <!-- No initial messages -->
        </div>
      </div>
    </main>
  </div>

  <!-- Fixed Input Area -->
  <footer class="chat-input-container">
    <button class="attachment-btn" id="uploadBtn"><i class="fas fa-paperclip"></i></button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <input type="text" id="userInput" placeholder="Type a message...">
    <button class="send-btn" id="sendBtn">Send</button>
  </footer>

  <!-- Page Watermark -->
  <div class="page-watermark">note.infinity-Ⅰ</div>

  <!-- =================================================================== -->
  <!-- NOTE - Cosmic Midnight (Free & Open-Source AI Script) -->
  <!-- This script connects to a free Hugging Face model. -->
  <!-- =================================================================== -->
  <script>
  // Wait for the entire HTML document to be loaded and parsed before running any script.
  document.addEventListener("DOMContentLoaded", async function() {

      // --- 1. ELEMENT AND VARIABLE INITIALIZATION ---
      const chatContainer = document.getElementById("chat-container");
      const chatDiv = document.getElementById("chat");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");
      const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
      const modeToggleBtn = document.getElementById("modeToggleBtn");

      let isEducationalMode = false;
      let conversationHistory = [];
      let activeLoadingProcesses = 0;

      let noteContent = { text: "", images: [], extractedText: [], summaries: [], actionItems: [] };

      const systemPrompt = `You are NOTE, an intelligent assistant that helps users understand and interact with their notes. 
      You have access to the user's current note content, which may include text, images, and extracted information.
      Always provide accurate, helpful responses based on the available content.
      When citing information, reference the source (e.g., "from your notes" or "from Wikipedia").
      Maintain a professional, helpful tone.`;

      // --- 2. FREE & OPEN-SOURCE AI CONFIGURATION ---
      // This section connects to a free Hugging Face model.

      // We are using the Hugging Face Inference API with a powerful, free model.
      const apiEndpoint = "https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2";
      // Note: This is a public endpoint. For high-traffic use, you should get your own token at hf.co/settings/tokens.
      const apiKey = null; // No key needed for this free public endpoint.

      // --- 3. INITIAL APPLICATION SETUP ---
      addMessage("Hello! I'm NOTE, now powered by a free and open-source AI. How can I help you today?", "note");

      function setupEventListeners() {
          sendBtn.addEventListener('click', handleUserInput);
          userInput.addEventListener('keydown', function(event) {
              if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleUserInput(); }
          });
          uploadBtn.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', handleFileUpload);
          scrollToBottomBtn.addEventListener('click', () => { chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); });
          modeToggleBtn.addEventListener('click', toggleConversationMode);
          chatContainer.addEventListener('scroll', handleScroll);
      }
      setupEventListeners();

      // --- 4. CORE HELPER FUNCTIONS ---
      function addMessage(text, sender, extraClass = '') {
          const messageDiv = document.createElement('div'); messageDiv.classList.add('message', sender); if (extraClass) messageDiv.classList.add(extraClass);
          const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add('message-bubble'); bubbleDiv.innerHTML = text;
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const timestampSpan = document.createElement('span'); timestampSpan.classList.add('timestamp'); timestampSpan.textContent = timestamp;
          messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(timestampSpan); chatDiv.appendChild(messageDiv);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); return messageDiv;
      }
      function manageLoadingIndicator() {
          const loader = chatDiv.querySelector('.loading-indicator-wrapper');
          if (activeLoadingProcesses > 0 && !loader) {
              const loaderDiv = document.createElement('div'); loaderDiv.classList.add('message', 'note', 'loading-indicator-wrapper');
              loaderDiv.innerHTML = `<div class="loading-indicator"><svg class="infinity-loader" viewBox="0 0 100 40"><path d="M20,20 Q30,5 40,20 T60,20 T80,20" /></svg></div>`;
              chatDiv.appendChild(loaderDiv); chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          } else if (activeLoadingProcesses <= 0 && loader) { loader.remove(); }
      }
      function showLoading() { activeLoadingProcesses++; manageLoadingIndicator(); }
      function hideLoading() { if (activeLoadingProcesses > 0) { activeLoadingProcesses--; } manageLoadingIndicator(); }
      function updateConversationHistory(role, content) { conversationHistory.push({ role, content, timestamp: Date.now() }); if (conversationHistory.length > 20) { conversationHistory = conversationHistory.slice(-20); } }
      function handleScroll() { const isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50; if (isAtBottom) { scrollToBottomBtn.classList.add('hidden'); } else { scrollToBottomBtn.classList.remove('hidden'); } }
      function toggleConversationMode() { isEducationalMode = !isEducationalMode; const modeText = isEducationalMode ? 'Educational Mode' : 'Casual Mode'; const modeIcon = isEducationalMode ? 'fa-graduation-cap' : 'fa-brain'; modeToggleBtn.innerHTML = `<i class="fas ${modeIcon}"></i>`; addMessage(`Switched to ${modeText}.`, "note", "assistant-highlight"); }

      // --- 5. CORE FEATURE HANDLERS ---
      async function handleFileUpload(event) {
          const file = event.target.files[0]; if (!file) return; if (!file.type.startsWith('image/')) { addMessage("Please upload an image file.", "note"); return; }
          const reader = new FileReader(); reader.onload = function(e) { const imageHtml = `<img src="${e.target.result}" alt="Uploaded Image" class="message-image">`; addMessage(imageHtml, "user"); }; reader.readAsDataURL(file);
          await processUploadedContent(file); fileInput.value = '';
      }
      async function processUploadedContent(file) {
          showLoading(); noteContent.images.push(file); let extractedText = "";
          try {
              const ocrResult = await Tesseract.recognize(file, 'eng', { logger: m => console.log(m) });
              extractedText = ocrResult.data.text;
              if (extractedText.trim()) { noteContent.extractedText.push(extractedText); addMessage(`🔎 I extracted this text from the image:`, "note"); addMessage(extractedText, "note", "ocr-result"); }
          } catch (error) { console.error("OCR failed:", error); addMessage("⚠️ I couldn't extract any text from the image.", "note"); }
          if (extractedText.trim()) {
              addMessage("🤖 Sending text to the free AI for analysis...", "note");
              const summaryPrompt = `Summarize the following text and extract any action items or to-dos. If there are no action items, just say "No action items found".\n\nText: """${extractedText}"""`;
              const summaryResult = await callCloudAI(summaryPrompt);
              if (summaryResult) { noteContent.summaries.push(summaryResult); addMessage(`📝 AI Analysis of Extracted Text:`, "note"); addMessage(summaryResult, "note"); }
          }
          hideLoading(); addMessage("✅ I have finished processing the image. You can now ask me questions about it.", "note", "assistant-highlight");
      }
      async function handleWikipedia(query) {
          showLoading();
          try {
              const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
              const summaryResponse = await fetch(summaryUrl);
              if (summaryResponse.ok) { const data = await summaryResponse.json(); hideLoading(); return data.extract || "I found a Wikipedia page, but it doesn't have a readable summary."; }
              else {
                  const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
                  const searchResponse = await fetch(searchUrl); const searchData = await searchResponse.json();
                  if (searchData.query && searchData.query.search.length > 0) { const title = searchData.query.search[0].title; return await handleWikipedia(title); }
                  else { hideLoading(); return `Sorry, I couldn't find a Wikipedia article for "${query}".`; }
              }
          } catch (error)  { console.error("Wikipedia API error:", error); hideLoading(); return `Sorry, I had trouble accessing Wikipedia. Please check your internet connection.`; }
      }
      function handleMath(expression) { try { const result = math.evaluate(expression); return `The result is: ${result}`; } catch (error) { return 'Invalid mathematical expression. Please check your syntax and try again.'; } }
      function handleChart(dataString) {
          const dataPairs = dataString.split(','); const labels = []; const data = [];
          for (const pair of dataPairs) { const [label, value] = pair.split(':').map(s => s.trim()); if (label && !isNaN(value)) { labels.push(label); data.push(parseFloat(value)); } }
          if (labels.length === 0) { addMessage("Invalid chart data. Please use the format: 'label:value, label:value'", "note"); return; }
          const messageElement = addMessage("", "note"); const bubble = messageElement.querySelector('.message-bubble'); bubble.textContent = "Here is your chart:"; const canvas = document.createElement('canvas'); bubble.appendChild(canvas);
          new Chart(canvas, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Data', data: data, backgroundColor: 'rgba(224, 230, 241, 0.5)', borderColor: 'rgba(224, 230, 241, 1)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: '#b8c5d6' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#b8c5d6' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { labels: { color: '#b8c5d6' } } } } });
      }

      // --- 6. FREE & OPEN-SOURCE AI COMMUNICATION ---
      async function callCloudAI(prompt) {
          try {
              // Hugging Face models expect a specific prompt format. We'll build it here.
              const formattedPrompt = `<s>[INST] ${systemPrompt}\n\nConversation History:\n${conversationHistory.map(h => `${h.role}: ${h.content}`).join('\n')}\n\nUser's Latest Message: "${prompt}" [/INST]`;
              
              const response = await fetch(apiEndpoint, {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                  body: JSON.stringify({ inputs: formattedPrompt, parameters: { max_new_tokens: 512, temperature: 0.7, return_full_text: false } })
              });

              if (!response.ok) { throw new Error(`Hugging Face API Error: ${response.statusText}`); }

              const result = await response.json();
              const aiResponse = result[0]?.generated_text;
              
              if (aiResponse) {
                  // The response from this model often includes the prompt, so we clean it up.
                  const cleanedResponse = aiResponse.replace(formattedPrompt, "").trim();
                  addStreamingMessage(cleanedResponse, "note");
                  return cleanedResponse;
              } else {
                  addMessage("I'm sorry, I received an empty response from the AI.", "note");
                  return null;
              }
          } catch (error) { console.error("Cloud AI call failed:", error); addMessage(`I'm sorry, I encountered an error with the AI service: ${error.message}`, "note"); return null; }
      }
      
      function addStreamingMessage(text, sender, extraClass = '') {
          const messageDiv = document.createElement('div'); messageDiv.classList.add('message', sender); if(extraClass) messageDiv.classList.add(extraClass);
          const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add('message-bubble'); 
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const timestampSpan = document.createElement('span'); timestampSpan.classList.add('timestamp'); timestampSpan.textContent = timestamp;
          messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(timestampSpan); chatDiv.appendChild(messageDiv);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          // Note: This specific Hugging Face endpoint doesn't support streaming, so we'll display the response all at once.
          bubbleDiv.textContent = text;
          return { messageDiv, bubbleDiv, appendText: function(text) { bubbleDiv.textContent += text; chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); } };
      }

      // --- 7. MAIN USER INPUT HANDLER ---
      async function handleUserInput() {
          const inputText = userInput.value.trim(); if (!inputText) return;
          addMessage(inputText, 'user'); updateConversationHistory('user', inputText); userInput.value = '';
          const lowerInput = inputText.toLowerCase();

          if (lowerInput === 'help') { const helpText = `<b>NOTE Commands:</b><br>- <b>math: [expression]</b> - Calculates a mathematical expression.<br>- <b>wiki: [topic]</b> - Fetches a summary from Wikipedia.<br>- <b>chart: [data]</b> - Creates a bar chart.<br>- Just type a message or question to chat with me!`; addMessage(helpText, "note"); return; }
          if (lowerInput === 'status') { const statusText = `<b>Free AI Status:</b><br>✅ <b>Model:</b> mistralai/Mistral-7B-Instruct-v0.2<br>✅ <b>Endpoint:</b> Hugging Face (Free)<br><br>Current Mode: ${isEducationalMode ? 'Educational' : 'Casual'}`; addMessage(statusText, "note"); return; }

          let intent = 'chat'; if (lowerInput.startsWith('math:')) intent = 'math'; if (lowerInput.startsWith('wiki:')) intent = 'wiki'; if (lowerInput.startsWith('chart:')) intent = 'chart';
  
          if (intent === 'math') { const expression = inputText.substring(5).trim(); addMessage(handleMath(expression), "note", "math-solution"); return; }
          if (intent === 'chart') { handleChart(inputText.substring(6).trim()); return; }
          if (intent === 'wiki') { const query = inputText.substring(5).trim(); const wikiSummary = await handleWikipedia(query); addMessage(`Here is what I found on Wikipedia about "${query}":\n\n${wikiSummary}`, "note"); return; }
        
          // Default to chat with Free Cloud AI
          showLoading();
          let contextText = "";
          if (noteContent.extractedText.length > 0) contextText += `Text Extracted from Images:\n${noteContent.extractedText.join('\n---\n')}\n\n`;
          if (noteContent.summaries.length > 0) contextText += `AI Summaries:\n${noteContent.summaries.join('\n---\n')}\n\n`;
          let wikipediaInfo = "";
          if (isEducationalMode || inputText.includes("?")) { const searchQuery = inputText.replace("?", "").trim(); addMessage(`🔍 Searching Wikipedia for "${searchQuery}"...`, "note"); wikipediaInfo = await handleWikipedia(searchQuery); }
          
          let finalPrompt = systemPrompt;
          if (contextText) finalPrompt += `\n\n--- Available Context from User's Notes ---\n${contextText}\n--- End of Context ---`;
          if (wikipediaInfo) finalPrompt += `\n\n--- Information from Wikipedia ---\n${wikipediaInfo}\n--- End of Wikipedia Info ---`;
          finalPrompt += `\n\nUser's Latest Message: "${inputText}"`;

          await callCloudAI(finalPrompt);
          hideLoading();
      }

  });
  </script>

</body>
</html>
          
